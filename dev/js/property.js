
var PackageCalendar=new Class({initialize:function(attachTo,packageCount){var scope=this;this.intro=new Element('p',{'class':'intro segment','html':'Select a package to begin'}).inject(attachTo);this.controls=new Element('div',{'class':'controls'}).inject(attachTo);this.container=new Element('ul',{'class':'packages segment'}).inject(attachTo);this.numOfNights=new Element('div',{'class':'num-of-nights'}).inject(attachTo.getNext());new Element('ul',{'class':'legend segment tenor','html':'<li class="available"><span class="icon"></span> Available</li>\
    <li class="waitlist"><span class="icon"></span>Standby</li>'}).inject(attachTo);attachTo.getNext().dispose().addClass('package-info').inject(attachTo);this.rows=new CalendarRows();this.events=new Element('br');var d=new Date();this.activeMonth=d.getMonth();this.activeYear=d.getFullYear();this.availableDates={};this.availableDatesByID={};this.packages=[];this.selectedPackage=null;this.selectedDates=[];this.minNumberOfPackagesforNav=1000;this.events.addEvent('tripupdate',function(){scope.updateCheckInOut(scope)});this.updateCheckInOut(scope);},updateCheckInOut:function(scope){var dates=scope.getSelectedDates();var checkinDate=dates[0];var checkoutDate=new Date(dates[dates.length-1]);if(checkinDate&&checkoutDate){var numNights=checkinDate.diff(checkoutDate)+1;var msg='<span class="num tenor">'+numNights+'</span> Night'+(numNights>1?'s':'');}else{msg='';}
this.numOfNights.set('html',msg);},addPackage:function(dates,id){var startDate=dates[0];if(this.lowestDate==null||startDate<this.lowestDate){this.lowestDate=new Date(startDate.getFullYear(),startDate.getMonth(),1);}else if(this.highestDate==null||startDate>this.highestDate){this.highestDate=new Date(startDate.getFullYear(),startDate.getMonth(),1);}
this.packages.push({startDate:dates[0],endDate:dates[dates.length-1],dates:dates,available:dates[0].available,waitList:dates[0].waitList});},dropPackages:function(){this.packages=[];},render:function(){var scope=this;this.container.getChildren().destroy();this.controls.getChildren().destroy();var activeDate=new Date(this.activeYear,this.activeMonth,1);if(activeDate<this.lowestDate)activeDate=this.lowestDate;else if(activeDate>this.highestDate)activeDate=this.highestDate;this.activeMonth=activeDate.getMonth();this.activeYear=activeDate.getFullYear();if(this.packages.length>=this.minNumberOfPackagesforNav){var surrounding=this.rows.getSurroundingMonths(this.activeMonth);if(activeDate.getYear()!=this.lowestDate.getYear()||activeDate.getMonth()!=this.lowestDate.getMonth()){var prevButton=new Element('a',{'class':'prev-month',href:'#',html:'&lsaquo; '+this.rows.getMonthName(surrounding.previous)}).inject(this.controls);prevButton.addEvent('click',function(){scope.activeMonth--;if(scope.activeMonth<0){scope.activeMonth=11;scope.activeYear--;}
scope.render();--scope.calendarPageIndex;return false;});}else{new Element('a',{'class':'prev-month'}).set('html','&nbsp;').inject(this.controls);}
var current=new Element('strong',{text:this.rows.getMonthName(this.activeMonth)+' '+this.activeYear}).inject(this.controls);if(activeDate.getYear()!=this.highestDate.getYear()||activeDate.getMonth()!=this.highestDate.getMonth()){var nextButton=new Element('a',{'class':'next-month',href:'#',html:this.rows.getMonthName(surrounding.next)+' &rsaquo;'}).inject(this.controls);nextButton.addEvent('click',function(){scope.activeMonth++;if(scope.activeMonth>11){scope.activeMonth=0;scope.activeYear++;}
scope.render();if(++scope.calendarPageIndex!=0){}
return false;});}else{new Element('a',{'class':'next-month'}).set('html','&nbsp;').inject(this.controls);}}
this.packages.each(function(pkg,index){var dateFormat='%a, %b %e';if(this.packages[0].startDate.getFullYear()!=this.packages.getLast().startDate.getFullYear()&&this.packages.length<this.minNumberOfPackagesforNav){dateFormat='%a, %b %e %Y'}
if(pkg.startDate.getMonth()==this.activeMonth||this.packages.length<this.minNumberOfPackagesforNav){var row=new Element('li',{'id':'pkg-row-'+index,'class':''}).inject(this.container);new Element('dl',{'class':'checkin tenor','html':'<dt class="checkin">'+(Jetsetter.property.propertyTypeId==4?'Departure':'Check In')+':</dt> <dd>'+pkg.startDate.format(dateFormat)+'</dd>'}).inject(row);new Element('dl',{'class':'checkout tenor','html':'<dt>'+(Jetsetter.property.propertyTypeId==4?'Return':'Check Out')+':</dt> <dd>'+new Date(pkg.endDate).increment('day',1).format(dateFormat)+'</dd>'}).inject(row);row.data=pkg;row.addEvent('click',function(){if(scope.selectedPackage){scope.selectedPackage.removeClass('selected');scope.selectedPackage.removeClass('waitlist-selected');if(scope.selectedPackage.id==this.id){scope.selectedPackage=undefined;scope.selectedDates=[];scope.events.fireEvent('tripupdate');return false;}}
scope.selectedPackage=this;if(pkg.waitList==true){scope.selectedPackage.addClass('waitlist-selected');}
scope.selectedPackage.addClass('selected');scope.events.fireEvent('tripupdate');});if(pkg.waitList){row.addClass('waitlist');}
if(pkg.available){row.addClass('available');}
if(pkg.dates==this.selectedDates){row.fireEvent('click');}}},this);if(this.packages.length==1){this.intro.hide();this.container.getFirst().fireEvent('click');}},getSelectedDates:function(){if(this.selectedPackage!=undefined){this.selectedDates=this.selectedPackage.data.dates;}
return this.selectedDates;}});var TripBuilder=new Class({initialize:function(attachTo,itemID,saleID,numRooms){var scope=this;this.itemID=itemID;this.saleID=saleID;this.numRooms;this.currentOrder={};this.lowestPrice=null;this.lowestTax=null;this.lowestFee=null;this.firstAvailableHoldDate=null;this.checkinTime=null;this.checkoutTime=null;this.inventoryWidget=null;this.calendar=null;this.packageData=null;this.toolType=null;this.events=new Element('br');this.calendarContainer=new Element('div').inject(attachTo);var zero=0;new Element('div',{'class':'segment'}).adopt(new Element('div',{'id':'subtotal','html':'<span class="label tenor">Subtotal:</span> <span class="value price tenor">'+zero.formatCurrency()+'</span>'}),new Element('div',{'class':'rooms','html':'<select id="quantity-list"><option value="1">1 Room</option><option value="2">2 Rooms</option><option value="3">3 Rooms</option><option value="4">4 Rooms</option></select>'})).inject(attachTo);this.actionContainer=new Element('div',{'class':'actions segment'}).inject(attachTo);this.holdForm=new Element('form',{'id':'hold-order-form','name':'hold-order-form','action':Jetsetter.SECURE_HOST+'/checkout?mode=hold','method':'POST'}).inject(this.actionContainer);this.holdInput=new Element('input',{'name':'input','type':'hidden'}).inject(this.holdForm);this.holdButton=new Element('div',{'class':'hold'}).inject(this.actionContainer);this.holdLink=new Element('button',{'type':'button','class':'tenor','id':'hold-btn','title':'Hold this','html':'Hold'}).inject(this.holdButton);this.tooltip=new Tooltip(attachTo);this.tooltip.container.set('id','actions-tooltip');this.tooltip.container.set('class','tooltip tenor');this.holdLink.addEvent('click',function(){if(Jetsetter.user.isAnonymous&&Jetsetter.user.isPriceHidden){Jetsetter.registrationModal.show();}else{if(scope.currentOrder!=null&&scope.currentOrder.ids!=null&&scope.currentOrder.ids.length>0&&scope.bookButton.hasClass('wait')==false){new OrderService().getCountOfActiveHolds({onSuccess:function(count){if(count>=3){var notificationModal=new NotificationModal('Oops! Jetsetter allows a maximum of three active holds at a time. Please contact Customer Support if you have questions.','error');notificationModal.show();}else{scope.currentOrder.isHold=true;scope.holdInput.set('value',JSON.encode(scope.currentOrder));Jetsetter.secureLogin(Object.merge({onCloseEnd:function(){},onLogin:function(){$('hold-order-form').submit();},setScreen:Jetsetter.user.hasIdentity?'SecureLogin':'CreatePassword'},Jetsetter.anonymousBrowse&&Jetsetter.anonymousBrowse.options.promoId?{promoId:Jetsetter.anonymousBrowse.options.promoId}:{}));}}.bind(this)});}else{scope.shakeSelectNights();}
return false;}});this.holdLink.addEvent('mouseenter',function(){scope.tooltip.show('If you need more time, hold this trip for the next 72 hours for 10% of the price. If you buy, the hold payment is applied to your purchase. If not, your hold will be refunded as a Jetsetter credit.',scope.holdLink,150);});this.holdLink.addEvent('mouseout',function(){scope.tooltip.hide();});this.whatsThisStandbyButtonDoLink=new Element('a',{'class':'standby-info action','text':'What’s Standby?'}).inject(this.actionContainer);this.whatsThisStandbyButtonDoLink.addEvent('mouseenter',function(){scope.tooltip.show('One or more of the dates you\'ve selected are sold out, but they may become available again before this sale ends. If you make a standby reservation, we\'ll automatically book you at the same rate if the dates open up.',this,150);});this.whatsThisStandbyButtonDoLink.addEvent('mouseout',function(){scope.tooltip.hide();});this.whatsThisStandbyButtonDoLink.hide();this.bookButton=new Element('button',{'type':'button','class':'book cta-button tenor','text':'Select'}).inject(this.actionContainer);var standbyTooltip=null;this.bookButton.addEvents({'click':function(){if(this.bookButton.hasClass('wait')){this.bookButton.set('disabled',true);}}.bind(this),'mouseenter':function(){if(this.bookButton.hasClass('wait')){standbyTooltip=standbyTooltip||new Tooltip(this.attachTo,{'className':'tenor order-tooltip order-tooltip-standby'});var standbyTooltipText='Some of your dates are sold out—but you can go on Standby. Click here for more information.';standbyTooltip.show(standbyTooltipText,this.bookButton,150);}}.bind(this),'mouseleave':function(){if(this.bookButton.hasClass('wait')){standbyTooltip.hide();}}.bind(this)});this.bookButton.addEvent('click',function(){if(Jetsetter.user.isAnonymous&&Jetsetter.user.isPriceHidden){Jetsetter.registrationModal.show();}else{var isStandby=this.hasClass('wait'),button=this;if(isStandby){Jetsetter.secureLogin(Object.merge({onCloseEnd:function(){button.set('disabled',false);},onLogin:function(){location='/checkout?mode=standby&inventory-ids='+scope.currentOrder.ids.join(',')+'&quantity='+scope.currentOrder.quantity;},setScreen:Jetsetter.user.hasIdentity?'SecureLogin':'CreatePassword'},Jetsetter.anonymousBrowse&&Jetsetter.anonymousBrowse.options.promoId?{promoId:Jetsetter.anonymousBrowse.options.promoId}:{}));return false;}
var order=scope.currentOrder;if(order&&order.ids&&order.ids.length>0){scope.bookButton.set('disabled',true).set('text','Submitting…');order.isHold=false;Jetsetter.secureLogin(Object.merge({dismissOnLogin:true,onCloseEnd:function(){scope.bookButton.set('disabled',false).set('text','Select');},onLogin:function(){var inventoryService=new InventoryService();inventoryService.isInventoryAvailable({inventoryIds:order.ids,quantity:order.quantity,onSuccess:function(data){location=Jetsetter.SECURE_HOST+'/checkout?items='+order.ids+'&quantity='+order.quantity+'&mode=order';}.bind(this),onFailure:function(code,message){scope.bookButton.set('disabled',false).set('text','Select');new NotificationModal(message,'error').show();throw new Error("ERROR "+code+": "+message);}.bind(this)});},setScreen:Jetsetter.user.hasIdentity?'SecureLogin':'CreatePassword'},Jetsetter.anonymousBrowse&&Jetsetter.anonymousBrowse.options.promoId?{promoId:Jetsetter.anonymousBrowse.options.promoId}:{}));}else{scope.shakeSelectNights();scope.tooltip.show('Please select a package above.',scope.bookButton);}
return false;}});this.events.addEvent('packagesupdated',function(packages){scope.buildCalendar(packages);});this.quantity=new DropDownList($('quantity-list'));this.quantity.events.addEvent('selectionupdate',function(){scope.updatePackages(scope.quantity.getSelectedItem().value,true);});this.updatePackages(numRooms);},shakeSelectNights:function(){var instructionEl;if(this.toolType=='packageCalendar'){instructionEl=this.calendarContainer.getElement('p.intro');}else{instructionEl=this.calendarContainer.getElement('.selected-nights p');}
instructionEl&&new Fx.Shake(instructionEl).start().chain(function(){instructionEl.setStyles({'position':'','left':''});});},updatePackages:function(numRooms,useOldData){numRooms=numRooms||1;var scope=this;if(useOldData==true){var packages=this.getPackagesFromData(this.packageData,numRooms);scope.numRooms=numRooms;this.events.fireEvent('packagesupdated',[packages]);return;}
var inventoryService=new InventoryService();inventoryService.getInventoryForItem({itemId:this.itemID,saleId:this.saleID,onSuccess:function(data){scope.toolType=Jetsetter.products[scope.itemID].inventoryWidget;scope.firstAvailableHoldDate=new Date(Jetsetter.firstAvailableHoldDate);scope.checkinTime=Jetsetter.property.check_in;scope.checkoutTime=Jetsetter.property.check_out;scope.inventoryWidget=Jetsetter.products[scope.itemID].inventoryWidget;scope.isExclusive=Jetsetter.products[scope.itemID].exclusive;scope.packageData=data.dates;scope.packageRestrictions=Jetsetter.products[scope.itemID].restrictions;var packages=scope.getPackagesFromData(scope.packageData,numRooms);scope.numRooms=numRooms;if(Browser.ie6||Browser.ie7){setTimeout(function(){scope.events.fireEvent('packagesupdated',[packages]);},0)}else{scope.events.fireEvent('packagesupdated',[packages]);}},onFailure:function(){}})},getPackagesFromData:function(data,numRooms){var scope=this;var index=0;var expectedDate;var currentPackage;var packages=[];data.each(function(inventoryItem,index){var year=Number(String(inventoryItem.bookingdate).substr(0,4));var month=Number(String(inventoryItem.bookingdate).substr(4,2))-1;var day=Number(String(inventoryItem.bookingdate).substr(6));var inventoryDate=new Date(year,month,day);if(!Jetsetter.user.isAdmin&&!Jetsetter.user.isAssumed&&new Date().diff(inventoryDate)<1){return;}
if(!expectedDate){expectedDate=inventoryDate;currentPackage=new Array();}else if(this.packageRestrictions.start_day&&inventoryDate.getDay()==this.packageRestrictions.start_day){packages.push(currentPackage.slice());expectedDate=inventoryDate;currentPackage=new Array();}else{var lastExpectedDate=expectedDate;expectedDate=new Date(expectedDate.getTime()+86400000);if(expectedDate.getTimezoneOffset()>lastExpectedDate.getTimezoneOffset()){expectedDate=new Date(expectedDate.getTime()+3600000);}else if(expectedDate.getTimezoneOffset()<lastExpectedDate.getTimezoneOffset()){expectedDate=new Date(expectedDate.getTime()-3600000);}}
if(Number(expectedDate)!=Number(inventoryDate)){packages.push(currentPackage.slice());currentPackage=new Array();expectedDate=inventoryDate;}
if(Number(inventoryItem.inventory_available)<numRooms){inventoryDate.waitList=true;}
inventoryDate.inventoryID=inventoryItem.id;inventoryDate.ratePlanId=inventoryItem.ratePlanId;inventoryDate.market_price=inventoryItem.market_price;inventoryDate.tax=inventoryItem.tax;inventoryDate.fees=inventoryItem.fees;inventoryDate.price=inventoryItem.price;inventoryDate.available=inventoryItem.inventory_available;inventoryDate.holdAvailable=Boolean(inventoryDate>=scope.firstAvailableHoldDate)&&!Jetsetter.disableHold;currentPackage.push(inventoryDate);},this);packages.push(currentPackage);return packages;},updateProductPrice:function(scope){var pricingEl=$('product-pricing');var ourPriceEl=pricingEl.getElement('.our-price');var compareEl=pricingEl.getElement('.compare');var product=Jetsetter.products[scope.itemID];ourPriceEl.set('html',(product.collapsePrice?('<span class="price">'+product.lowestPackage.formatCurrency()+'</span>'):('from <span class="price">'+scope.lowestPrice.formatCurrency()+'</span> / night')));if(scope.isExclusive){compareEl.addClass('exclusive').removeClass('other-price');compareEl.set('text','Only on Jetsetter');}else{compareEl.addClass('other-price').removeClass('exclusive');var str=Jetsetter.property.calendarType==='package'?'Actual Value':'Hotel website';compareEl.set('html',str+' <del>'+(product.collapsePrice?product.lowestPackageRetail.formatCurrency():scope.avgMarketPrice.formatCurrency()+'/night')+'</del>');}},buildCalendar:function(packages){var scope=this;var monthOverride=null;var packageOverride=null;var datesOverride=null;if(this.calendar){this.calendar.dropPackages();}else{switch(this.toolType){case'packageCalendar':this.quantity.container.getParent().destroy();this.calendar=new PackageCalendar(this.calendarContainer.set('id','packageCalendar'),packages.length);break;default:this.calendar=new ProductCalendar(this.calendarContainer.set('id','productCalendar'),this.packageRestrictions.min_stay,this.packageRestrictions.max_stay);break;}}
this.events.fireEvent('calendarCreated');if(monthOverride)this.calendar.activeMonth=monthOverride;if(datesOverride)this.calendar.selectedDatesOffscreen=datesOverride;if(packageOverride)this.calendar.selectedPackageIndex=packageOverride;packages.each(function(pkg){scope.calendar.addPackage(pkg);});if(this.toolType=='packageCalendar'){scope.lowestPrice=null;scope.lowestTax=null;scope.lowestFee=null;scope.avgMarketPrice=null;scope.avgMarketTaxFees=null;var divisor=0;this.calendar.packages.each(function(packageChunk,index){var totalPrice=0;var totalMarketPrice=0;packageChunk.dates.each(function(date,index){totalPrice+=Number(date.price);totalMarketPrice+=Number(date.market_price);if(date.price<scope.lowestPrice||scope.lowestPrice==null){scope.lowestPrice=Math.floor(date.price);scope.lowestTax=Number(packageChunk.startDate.tax);scope.lowestFee=Number(packageChunk.startDate.fees);scope.avgMarketPrice=Math.floor(packageChunk.startDate.market_price);scope.avgMarketTaxFees=scope.lowestTax+scope.lowestFee;}});});var lowestPrice=scope.lowestPrice||0;var marketPrice=scope.avgMarketPrice||0;scope.updateProductPrice(scope);}else{this.calendar.events.addEvent('render',function(){scope.lowestPrice=null;scope.lowestTax=null;scope.lowestFee=null;scope.avgMarketPrice=null;scope.avgMarketTaxFees=null;var divisor=0;$$('.calendar .available').each(function(dayElement,index){var date=scope.calendar.availableDates.get(dayElement.key);if(date.getMonth()==scope.calendar.activeMonth){var price=date.price;if(price<scope.lowestPrice||scope.lowestPrice==null){scope.lowestPrice=Math.ceil(price);scope.lowestTax=Math.ceil(date.tax);scope.lowestFee=Math.ceil(date.fees);}
scope.avgMarketPrice+=Number(date.market_price);scope.avgMarketTaxFees+=(Number(date.tax)+Number(date.fees));divisor++;}});scope.calendar.applyPremiums(scope.lowestPrice);scope.avgMarketPrice=Math.ceil(scope.avgMarketPrice/divisor);scope.avgMarketTaxFees=Math.ceil(scope.avgMarketTaxFees/divisor);scope.updateProductPrice(scope);});}
this.calendar.events.addEvent('tripupdate',function(){var dates=scope.calendar.getSelectedDates();var totalPrice=0;var waitList=false;var noHold=Jetsetter.disableHold;var checkinDate=dates[0];var checkoutDate=new Date(dates[dates.length-1]);var order={ids:[],quantity:scope.quantity.getSelectedItem().value,attribute:"Room",isHold:false};dates.each(function(date){totalPrice+=Number(date.price);if(date.waitList)waitList=true;if(!date.holdAvailable)noHold=true;order.ids.push(date.inventoryID);order.ratePlanId=date.ratePlanId;});$('subtotal').getElement('.value').set('text',(totalPrice*order.quantity).formatCurrency());if(noHold){scope.holdButton.hide();}else{scope.holdButton.show();}
scope.whatsThisStandbyButtonDoLink.hide();if(waitList){scope.bookButton.set('text','Go on Standby').addClass('wait');scope.whatsThisStandbyButtonDoLink.show();scope.holdButton.hide();}else{scope.bookButton.set('text','Select').removeClass('wait');if(!noHold){scope.holdButton.show();}}
scope.currentOrder=order;});if(this.toolType!='packageCalendar'){this.calendar.minLength=this.packageRestrictions.min_stay||1;this.calendar.maxLength=this.packageRestrictions.max_stay==0?21:Math.min(this.packageRestrictions.max_stay,21);}
this.calendar.render();}});var Inventory=new Class({Implements:Events,initialize:function(propertyId,eventId){var data={propertyId:propertyId,jsonp:true};if(eventId){data.eventId=eventId;}
this.InventoryService=new InventoryService();this.InventoryService.getInventoryForPropertyByPropertyId({propertyId:data.propertyId,eventId:data.eventId,onSuccess:function(data){this.products=data.products;if(Browser.ie6||Browser.ie7){setTimeout(this.fireEvent.bind(this,'ready'),0);}else{this.fireEvent('ready');}}.bind(this),onFailure:function(){var noInventoryBanner=this.getNoInventoryBanner();noInventoryBanner.hide();noInventoryBanner.inject($('page-content'),'before');var noInventoryReveal=new Fx.Reveal(noInventoryBanner,{'duration':200});noInventoryReveal.reveal();}.bind(this)});this.propertyId=propertyId;this.eventId=eventId!=null?eventId:0;this.soldOutSelectable=!!this.eventId;},getAvailableCheckInDates:function(checkOutDate,numOfRooms,numOfGuests){numOfRooms=numOfRooms||1;var availableDates={};var availableProductIds=this.getAvailableProductIdsFromInventory(null,checkOutDate,numOfRooms,numOfGuests);Object.each(this.products,function(product,productId){if(!product.dates){return;}
if(!Jetsetter.products[productId]){return;}
var productMinStay=Jetsetter.products[productId].minStay;var productMaxStay=Jetsetter.products[productId].maxStay||28;var dates=product.dates;dateKeys=Object.keys(dates).sort().reverse();var lastDate=dateKeys[0].toDateObject();var firstDate=dateKeys[dateKeys.length-1].toDateObject();for(var bookingDate=lastDate;bookingDate>=firstDate;bookingDate.decrement('day',1)){if(checkOutDate&&bookingDate>=checkOutDate){continue;}
var key=bookingDate.toBookingDateString();var checkInInventory=dates[key];if(!checkInInventory){if(checkOutDate&&bookingDate<checkOutDate){break;}
continue;}
var dayInfo=Object.clone(availableDates[key]||{isAvailable:false});var checkOutInventory=checkOutDate?dates[checkOutDate.toBookingDateString()]:null;var lengthOfStay=checkOutDate?bookingDate.diff(checkOutDate,'day'):null;var validRatePlans=[];Object.each(checkInInventory.ratePlans,function(ratePlan,ratePlanId){if(ratePlan.restriction&&ratePlan.restriction.indexOf('Master')!=-1){return;}
ratePlan.stayMinLOS=Math.max(checkInInventory.minStay,productMinStay,ratePlan.minLOS||1,ratePlan.forwardMinLOS||1);ratePlan.stayMaxLOS=Math.min(checkInInventory.maxStay,productMaxStay,ratePlan.maxLOS||28,ratePlan.forwardMaxLOS||28)||28;ratePlan.stayAvailability=ratePlan.bookingLimit!=null?Math.min(checkInInventory.availability,ratePlan.bookingLimit):checkInInventory.availability;var forwardLengthOfStay=0;do{forwardLengthOfStay+=1;var stayDate=bookingDate.clone().increment('day',forwardLengthOfStay);if(dates[stayDate.toBookingDateString()]&&dates[stayDate.toBookingDateString()].ratePlans[ratePlanId]&&dates[stayDate.toBookingDateString()].ratePlans[ratePlanId].restriction&&dates[stayDate.toBookingDateString()].ratePlans[ratePlanId].restriction.indexOf('Departure')!=-1){ratePlan.stayMinLOS++;}
var minStay=Math.max(checkOutDate?bookingDate.diff(checkOutDate,'day'):0,ratePlan.stayMinLOS)-1;if(forwardLengthOfStay>minStay){break;}
if(checkOutDate&&stayDate>checkOutDate.clone().decrement('day',1)){break;}
var stayInventory=dates[stayDate.toBookingDateString()];if(!stayInventory){return;}
var stayRatePlan=stayInventory.ratePlans[ratePlanId];if(!stayRatePlan){return;}
if(stayRatePlan.restriction&&stayRatePlan.restriction.indexOf('Master')!=-1){return;}
ratePlan.stayAvailability=Math.min(ratePlan.stayAvailability,stayInventory.availability,stayRatePlan.bookingLimit!=null?stayRatePlan.bookingLimit:ratePlan.stayAvailability);ratePlan.stayMinLOS=Math.max(ratePlan.stayMinLOS,stayInventory.minStay||1,stayRatePlan.forwardMinLOS||1);ratePlan.stayMaxLOS=Math.min(ratePlan.stayMaxLOS,stayInventory.maxStay||28,stayRatePlan.forwardMaxLOS||28);}while(true);validRatePlans.push(ratePlan);}.bind(this));if(!validRatePlans.length){if(checkOutDate&&bookingDate<checkOutDate){availableProductIds.erase(productId);break;}
continue;}
var arrivable=false;var available=true;for(var i=0;i<validRatePlans.length;i++){var ratePlan=validRatePlans[i];if(ratePlan.stayAvailability<numOfRooms&&this.soldOutSelectable==false){available=false;continue;}
dayInfo.availability=Math.max(dayInfo.availability,ratePlan.stayAvailability)||ratePlan.stayAvailability;dayInfo.minStay=Math.min(dayInfo.minStay,ratePlan.stayMinLOS)||ratePlan.stayMinLOS;dayInfo.maxStay=Math.max(dayInfo.maxStay,ratePlan.stayMaxLOS)||ratePlan.stayMaxLOS;if(ratePlan.restriction&&ratePlan.restriction.indexOf('Arrival')!=-1){continue;}
if(lengthOfStay!=null){if(ratePlan.fplos&&((Object.keys(ratePlan.fplos).length>=lengthOfStay&&ratePlan.fplos[lengthOfStay]==false)||(Object.keys(ratePlan.fplos).length<lengthOfStay&&ratePlan.fplos[Object.keys(ratePlan.fplos).length]==false))){continue;}}
arrivable=true;available=true;dayInfo.price=Math.min(dayInfo.price,ratePlan.price)||ratePlan.price;dayInfo.marketPrice=Math.min(dayInfo.marketPrice,ratePlan.marketPrice)||ratePlan.marketPrice;}
if(lengthOfStay!=null){if(lengthOfStay<0){continue;}
if(lengthOfStay<dayInfo.minStay){continue;}
if(lengthOfStay>dayInfo.maxStay){availableProductIds.erase(productId);break;}}
if(!arrivable){if(!available){if(checkOutDate&&bookingDate<checkOutDate){availableProductIds.erase(productId);break;}}
continue;}
availableDates[key]=dayInfo;if(dayInfo.availability<numOfRooms){if(checkOutDate&&bookingDate<checkOutDate){availableProductIds.erase(productId);}
continue;}
if(!availableProductIds.contains(productId)){continue;}
dayInfo.isAvailable=true;}},this);if(Object.getLength(availableDates)===0){throw'No available dates found';}
var availableKeys=Object.keys(availableDates).sort();availableDates.earliestDate=availableKeys[0].toDateObject();availableDates.latestDate=availableKeys[availableKeys.length-1].toDateObject();return availableDates;},getAvailableCheckOutDates:function(checkInDate,numOfRooms,numOfGuests){numOfRooms=numOfRooms||1;var availableDates={};var availableProductIds=this.getAvailableProductIdsFromInventory(checkInDate,null,numOfRooms,numOfGuests);Object.each(this.products,function(product,productId){if(!product.dates){return;}
if(!Jetsetter.products[productId]){return;}
var productMinStay=Jetsetter.products[productId].minStay;var productMaxStay=Jetsetter.products[productId].maxStay||28;var dates=product.dates;dateKeys=Object.keys(dates).sort();var firstDate=dateKeys[0].toDateObject();var lastDate=dateKeys[dateKeys.length-1].toDateObject().increment('day',1);for(var bookingDate=firstDate;bookingDate<lastDate;bookingDate.increment('day',1)){if(checkInDate&&bookingDate<=checkInDate.clone().increment('day',-1)){continue;}
var key=bookingDate.toBookingDateString();var checkOutInventory=dates[key];if(!checkOutInventory){if(checkInDate&&bookingDate>=checkInDate){break;}
continue;}
var checkOutKey=bookingDate.clone().increment('day',1).toBookingDateString();var dayInfo=Object.clone(availableDates[checkOutKey]||{isAvailable:false});var checkInInventory=checkInDate?dates[checkInDate.toBookingDateString()]:null;var lengthOfStay=checkInDate?checkInDate.diff(bookingDate,'day')+1:null;var validRatePlans=[];Object.each(checkOutInventory.ratePlans,function(ratePlan,ratePlanId){ratePlan.ratePlanId=ratePlanId;if(ratePlan.restriction&&ratePlan.restriction.indexOf('Master')!=-1){return;}
ratePlan.stayMinLOS=Math.max(productMinStay,checkOutInventory.minStay,ratePlan.forwardMinLOS||0);ratePlan.stayMaxLOS=Math.min(productMaxStay,ratePlan.forwardMaxLOS||28)||28;ratePlan.stayAvailability=ratePlan.bookingLimit!=null?Math.min(checkOutInventory.availability,ratePlan.bookingLimit):checkOutInventory.availability;if(checkInInventory){ratePlan.stayMinLOS=Math.max(ratePlan.stayMinLOS,checkInInventory.minStay);ratePlan.stayMaxLOS=Math.min(ratePlan.stayMaxLOS,checkInInventory.maxStay||28);var checkInRatePlan=checkInInventory.ratePlans[ratePlanId];if(!checkInRatePlan){return;}
if(checkInRatePlan.restriction&&(checkInRatePlan.restriction.indexOf('Arrival')!=-1||checkInRatePlan.restriction.indexOf('Master')!=-1)){return;}
ratePlan.stayAvailability=Math.min(ratePlan.stayAvailability,checkInRatePlan.stayAvailability);ratePlan.stayMinLOS=Math.max(ratePlan.stayMinLOS,checkInRatePlan.minLOS||0,checkInRatePlan.forwardMinLOS||0);ratePlan.stayMaxLOS=Math.min(ratePlan.stayMaxLOS,checkInRatePlan.maxLOS||28,checkInRatePlan.forwardMaxLOS||28);}
var backwardLengthOfStay=0;do{backwardLengthOfStay+=1;var stayDate=bookingDate.clone().decrement('day',backwardLengthOfStay);var minStay=Math.max(checkInDate?checkInDate.diff(bookingDate,'day'):0,ratePlan.stayMinLOS)-1;if(backwardLengthOfStay>minStay){break;}
if(checkInDate&&stayDate<checkInDate){break;}
var stayInventory=dates[stayDate.toBookingDateString()];if(!stayInventory){return;}
var stayRatePlan=stayInventory.ratePlans[ratePlanId];if(!stayRatePlan){return;}
if(stayRatePlan.restriction&&stayRatePlan.restriction.indexOf('Master')!=-1){return;}
ratePlan.stayAvailability=Math.min(ratePlan.stayAvailability,stayInventory.availability,stayRatePlan.bookingLimit!=null?stayRatePlan.bookingLimit:ratePlan.stayAvailability);ratePlan.stayMinLOS=Math.max(ratePlan.stayMinLOS,stayInventory.minStay||0,stayRatePlan.forwardMinLOS||0);ratePlan.stayMaxLOS=Math.min(ratePlan.stayMaxLOS,stayInventory.maxStay||28,stayRatePlan.forwardMaxLOS||28);}while(true);validRatePlans.push(ratePlan);}.bind(this));if(!validRatePlans.length){if(checkInDate&&bookingDate>checkInDate){availableProductIds.erase(productId);break;}
continue;}
var departable=false;var available=true;for(i=0;i<validRatePlans.length;i++){var ratePlan=validRatePlans[i];var ratePlanId=ratePlan.ratePlanId;if(ratePlan.stayAvailability<numOfRooms&&this.soldOutSelectable==false){available=false;continue;}
dayInfo.availability=Math.max(dayInfo.availability,ratePlan.stayAvailability)||ratePlan.stayAvailability;dayInfo.minStay=Math.min(dayInfo.minStay,ratePlan.stayMinLOS)||ratePlan.stayMinLOS;dayInfo.maxStay=Math.max(dayInfo.maxStay,ratePlan.stayMaxLOS)||ratePlan.stayMaxLOS;if(tomorrowInventory=dates[bookingDate.clone().increment('day',1).toBookingDateString()]){var tomorrowRatePlan=tomorrowInventory.ratePlans[ratePlanId];if(tomorrowRatePlan&&tomorrowRatePlan.restriction&&tomorrowRatePlan.restriction.indexOf('Departure')!=-1){continue;}}
if(checkInInventory){var checkInRatePlan=checkInInventory.ratePlans[ratePlanId];if(checkInRatePlan.fplos&&((Object.keys(checkInRatePlan.fplos).length>=lengthOfStay&&checkInRatePlan.fplos[lengthOfStay]==false)||(Object.keys(checkInRatePlan.fplos).length<lengthOfStay&&checkInRatePlan.fplos[Object.keys(checkInRatePlan.fplos).length]==false))){continue;}}
departable=true;available=true;dayInfo.price=Math.min(dayInfo.price,ratePlan.price)||ratePlan.price;dayInfo.marketPrice=Math.min(dayInfo.marketPrice,ratePlan.marketPrice)||ratePlan.marketPrice;}
if(lengthOfStay!=null){if(lengthOfStay<0){continue;}
if(lengthOfStay<dayInfo.minStay){continue;}
if(lengthOfStay>dayInfo.maxStay){availableProductIds.erase(productId);break;}}
if(!departable){if(!available||!dayInfo.availability){if(checkInDate&&bookingDate>checkInDate){availableProductIds.erase(productId);break;}}
continue;}
availableDates[checkOutKey]=dayInfo;if(dayInfo.availability<numOfRooms){if(checkInDate&&bookingDate>checkInDate){availableProductIds.erase(productId);}
continue;}
if(!availableProductIds.contains(productId)){continue;}
dayInfo.isAvailable=true;}},this);if(Object.getLength(availableDates)===0){throw'No available dates found';}
var availableKeys=Object.keys(availableDates).sort();availableDates.earliestDate=availableKeys[0].toDateObject();availableDates.latestDate=availableKeys[availableKeys.length-1].toDateObject();return availableDates;},getAvailableProductIdsFromInventory:function(checkInDate,checkOutDate,numOfRooms,numOfGuests){numOfRooms=numOfRooms||1;var productStates=this.getProductStatesFromInventory(checkInDate,checkOutDate,numOfRooms,numOfGuests);var availableProductIds=[];Object.each(productStates,function(productState,productId){if(productState.isAvailable){availableProductIds.push(productId);}});return availableProductIds;},getProductInventory:function(productId){return this.products[productId];},getProductStatesFromInventory:function(checkInDate,checkOutDate,numOfRooms,numOfGuests){var productStates={};Object.each(this.products,function(product,productId){if(!Jetsetter.products[productId]||_.size(product.dates)==0){return;}
var productMinStay=Jetsetter.products[productId].minStay;var productMaxStay=Jetsetter.products[productId].maxStay||28;var productMaxOccupancy=Jetsetter.products[productId].maxOccupancy;var dates=product.dates;productStates[productId]={'isAvailable':true}
if(numOfGuests!=null&&productMaxOccupancy>0&&(productMaxOccupancy*numOfRooms)<numOfGuests){productStates[productId]={'isAvailable':false,'reason':'max occupancy'}
return;}
if(checkInDate&&checkOutDate){var days=checkInDate.diff(checkOutDate,'day');var selectionMinStay=productMinStay;for(var i=0;i<days;i++){var dateInventory=dates[checkInDate.clone().increment('day',i).toBookingDateString()];if(!dateInventory){productStates[productId]={'isAvailable':false,'reason':'no allocation'};return;}
selectionMinStay=Math.max(selectionMinStay,dateInventory.minStay);}
if(days<selectionMinStay){productStates[productId]={'isAvailable':false,'reason':'below min stay'};return;}
if(days>productMaxStay){productStates[productId]={'isAvailable':false,'reason':'above max stay'};return;}
for(var i=0;i<days;i++){var dateInventory=dates[checkInDate.clone().increment('day',i).toBookingDateString()];if(!dateInventory){productStates[productId]={'isAvailable':false,'reason':'no allocation'};break;}else if(dateInventory.availability<numOfRooms){productStates[productId]={'isAvailable':false,'reason':'sold out'};}}}else{if(checkInDate){var checkInDateInventory=dates[checkInDate.toBookingDateString()];if(!checkInDateInventory){productStates[productId]={'isAvailable':false,'reason':'no allocation'};}else if(checkInDateInventory.availability<numOfRooms){productStates[productId]={'isAvailable':false,'reason':'sold out'};}}
if(checkOutDate){var checkOutDateInventory=dates[checkOutDate.toBookingDateString()];if(!checkOutDateInventory){productStates[productId]={'isAvailable':false,'reason':'no allocation'};}else if(checkOutDateInventory.availability<numOfRooms){productStates[productId]={'isAvailable':false,'reason':'sold out'};}}}},this);return productStates;},getInventoryIdsForOrder:function(checkInDate,checkOutDate,selectedProductId){var dates=this.getProductInventory(selectedProductId).dates;var days=checkInDate.diff(checkOutDate,'day');var dateInventory=null,inventoryIds=[];for(var i=0;i<days;i++){dateInventory=dates[checkInDate.clone().increment('day',i).toBookingDateString()];if(!dateInventory){return;}
inventoryIds.push(dateInventory.inventoryId);}
return inventoryIds;},getPricing:function(checkInDate,checkOutDate){if(this.pricing||!checkInDate||!checkOutDate){this.fireEvent('pricingReady');return;}
var data={propertyId:this.propertyId,checkin:checkInDate.toBookingDateString(),checkout:checkOutDate.toBookingDateString(),numRooms:1};if(this.eventId){data.eventId=this.eventId;}
this.ProductService=new ProductService();this.ProductService.getPricingByTrip({propertyId:this.propertyId,eventId:this.eventId,checkin:checkInDate.toBookingDateString(),checkout:checkOutDate.toBookingDateString(),numRooms:1,onSuccess:function(data){if(data.length===0){return this.fireEvent('pricingError');}
var pricing={};var productOrder=new Array();for(var i=0;i<data.length;i++){var productPricing=data[i];if(!pricing[productPricing.productId]||pricing[productPricing.productId].discountedSubtotal>productPricing.discountedSubtotal){pricing[productPricing.productId]=productPricing;productOrder.push(productPricing.productId);}}
this.pricing=pricing;this.productOrder=productOrder;this.fireEvent('pricingReady');}.bind(this),onFailure:function(){this.fireEvent('pricingError');}.bind(this)})},clearPricing:function(){this.pricing=null;this.productOrder=null;},getProductStatesFromPricing:function(checkInDate,checkOutDate,numOfRooms,numOfGuests){var productStates=this.getProductStatesFromInventory(checkInDate,checkOutDate,numOfRooms,numOfGuests);Object.each(this.products,function(product,productId){if(!this.pricing[productId]){if(!productStates[productId]||productStates[productId].isAvailable==false){return;}else{productStates[productId]={isAvailable:false,'reason':'pricing'}}}else{if(!productStates[productId]||productStates[productId].isAvailable==false){return;}
var productPricing=this.pricing[productId];if(!productPricing.subtotal){productStates[productId]={'isAvailable':false,'reason':productPricing.reason};return;}
if(productPricing.isAvailable==false){productStates[productId]={'isAvailable':false,'reason':productPricing.reason=='Availability'?'sold out':productPricing.reason};return;}
for(bookingDate in productPricing.dates){if(productPricing.dates[bookingDate].availability<numOfRooms){productStates[productId]={'isAvailable':false,'reason':'sold out'};return;}}
productStates[productId]={'isAvailable':productPricing.isAvailable,'reason':productPricing.reason,'discountedSubtotal':productPricing.discountedSubtotal};}},this);return productStates;},getProductPrices:function(checkInDate,checkOutDate,numOfRooms){var productPrices={};if(!this.pricing){return productPrices;}
var days=checkInDate.diff(checkOutDate,'day');Object.each(this.products,function(product,productId){if(this.pricing[productId]){productPrices[productId]={averagePrice:this.pricing[productId].avgPrice};}},this);return productPrices;},getProductOrder:function(){return this.productOrder;},getAvailableProductIdsFromPricing:function(checkInDate,checkOutDate,numOfRooms,numOfGuests){numOfRooms=numOfRooms||1;var productStates=this.getProductStatesFromPricing(checkInDate,checkOutDate,numOfRooms,numOfGuests);var availableProductIds=[];Object.each(productStates,function(productState,productId){if(productState.isAvailable){availableProductIds.push(productId);}});return availableProductIds;},getSubtotalForProductFromPricing:function(productId){if(!this.pricing){return 0;}
return this.pricing[productId].discountedSubtotal;},getPricingObjectForProductId:function(productId){if(!this.pricing){return 0;}
return this.pricing[productId];},getFirstAvailableHoldDate:function(productId){if(!Jetsetter.products[productId]){return new Date(100000000*86400000);}
return new Date(Jetsetter.firstAvailableHoldDate);},getMinStayforDay:function(key){var min=0;Object.each(this.products,function(product,productId){if(product.dates[key]){var curMin=product.dates[key].minStay;if(curMin>min){min=curMin;}}},this);return min;},isAvailable:function(options){var checkInDateAvailable=(options.checkInDate===undefined||options.checkInDate=='');var checkOutDateAvailable=(options.checkOutDate===undefined||options.checkOutDate=='');if((options.checkInDate===undefined||options.checkInDate=='')||(options.checkOutDate===undefined||options.checkOutDate=='')){return true;}
try{var availableCheckInDates=this.getAvailableCheckInDates(options.checkOutDate,options.numOfRooms,options.numOfGuests);var availableCheckOutDates=this.getAvailableCheckOutDates(options.checkInDate,options.numOfRooms,options.numOfGuests);var haveSelectedDates=options.checkInDate&&options.checkOutDate&&availableCheckInDates[options.checkInDate.toBookingDateString()]&&availableCheckOutDates[options.checkOutDate.toBookingDateString()];if(haveSelectedDates){return haveSelectedDates.isAvailable;}else{return false;}}catch(err){return false;}},getNoInventoryBanner:function(){var container=new Element('div',{'id':'no-inventory'});new Element('div',{'id':'no-inventory-img'}).inject(container);new Element('div',{'id':'no-inventory-message','html':'We\'re sorry, the nights you were looking for are no longer available.'}).inject(container);return container;},getRatePlanIdForProductId:function(productId){if((!this.pricing)||(!this.pricing[productId])){return null;}
return this.pricing[productId].ratePlanId;}});var DecisionModal=new Class({Implements:[Events,Options],initialize:function(attachTo,message){this.attachTo=attachTo;this.overlay=new Element('div',{'class':'overlay'});this.buttonContainer=new Element('div',{'class':'button-container','html':'<p class="message tenor">'+message+'</p>'});this.rootEl=new Element('div',{'class':'decision-modal'}).adopt(this.overlay,this.messageEl,this.buttonContainer).inject(attachTo).hide();},addButton:function(name,callback){return new Element('button',{'class':'tenor','type':'button','text':name}).addEvent('click',function(){this.hide();callback(arguments);}.bind(this)).inject(this.buttonContainer);},hide:function(){this.overlay.tween('opacity',0);this.buttonContainer.tween('margin-bottom',-(this.buttonContainer.getSize().y)).get('tween').chain(function(){this.rootEl.destroy();}.bind(this));},show:function(){this.cancelButton=this.addButton('Cancel',function(){this.fireEvent('cancel');}.bind(this)).addClass('cancel');this.rootEl.show();this.buttonContainer.setStyle('margin-bottom',-(this.buttonContainer.getSize().y));if(Browser.ie6||Browser.ie7){this.rootEl.setStyle('height',this.attachTo.getSize().y);}
this.overlay.set('tween',{duration:150}).fade('hide').fade(0.5);this.buttonContainer.set('tween',{duration:250}).tween('margin-bottom',0);}});var ProductTooltip=new Class({Extends:Tooltip,initialize:function(attachTo){this.parent(attachTo);},setPosition:function(element){var tooltipSize=this.container.getSize();var elementPosition=element.getPosition(this.attachTo);this.container.setStyles({'left':-(tooltipSize.x+2),'top':elementPosition.y-(tooltipSize.y-element.getSize().y)/2});}});var ProductPromoTooltip=new Class({Extends:ProductTooltip,initialize:function(attachTo,promo){this.parent(attachTo);this.html=this.getHtml(promo);},getHtml:function(promo){var info=new Element('div',{'class':'info'});var title=new Element('h4',{'class':'name tenor'});var titleIcon=new Element('span',{'class':'type-icon'});var titleText=new Element('span',{'class':'title','html':promo.description});title.adopt(titleIcon);title.adopt(titleText);var description=new Element('p',{'class':'description tenor','html':promo.publicDescription});info.adopt(title);info.adopt(description);return info;},show:function(element,delay){this.parent(this.html,element,delay)}});var ProductTypes=new Class({Implements:Events,initialize:function(rootEl){this.rootEl=rootEl;this.productEls=this.rootEl.getElements('li');this.selectedProductEl=null;var tooltip=new ProductTooltip(this.rootEl);this.rootEl.getElements('.description').each(function(element){var shortDescription=element.get('text').trim().truncate(75);element.set('text',shortDescription);});this.rootEl.addEvents({'click:relay(li)':function(event,element){this._selectProductEl(element);this.fireEvent('productChange',this.getSelectedId());}.bind(this),'mouseover:relay(li)':function(event,element){element.addClass('hover');},'mouseout:relay(li)':function(event,element){element.removeClass('hover');}});this.productEls.addEvents({'mouseenter':function(event){var element=$(event.target);if(element.get('tag')!='li'){element=element.getParent('li');}
if(!element){return false;}
var tooltipContent=element.retrieve('tooltipContent');if(!tooltipContent){var productId=this._getIdFromElement(element);var product=Jetsetter.products[productId];if(product){tooltipContent=new Element('div');var imageEl=element.getElement('.thumb').dispose();var infoEl=element.getElement('.info').clone();infoEl.getElement('.price').dispose();var additional=(product.additionalDetails||[])[0]||'';additional=additional?additional[0].toLowerCase()+additional.substring(1):'';var description=product.description.join(' ')+(additional?'; '+additional:'');infoEl.getElement('.description').set('text',description);if(element.hasClass('sold-out')){new Element('div',{'html':'Available for standby only','class':'tenor'}).inject(infoEl);}
tooltipContent.adopt(imageEl,infoEl);element.store('tooltipContent',tooltipContent);}}
tooltip.show(tooltipContent.get('html'),element,100);}.bind(this),'mouseleave':function(event){var element=$(event.target);if(element.get('tag')!='li'){element=element.getParent('li');}
if(!element){return false;}
tooltip.hide();}});this.selectDefaultProduct();},_getIdFromElement:function(element){var productId=element.get('id');return productId.substr(productId.lastIndexOf('-')+1);},_selectProductEl:function(element){if(!this.selectedProductEl||this._getIdFromElement(element)!=this._getIdFromElement(this.selectedProductEl)){if(this.selectedProductEl){this.selectedProductEl.removeClass('selected');}
this.selectedProductEl=element.addClass('selected');this.selectedProductEl.getElement('input').set('checked',true);this.fireEvent('productChange',this.getSelectedId());}},getSelectedId:function(){return parseInt(this._getIdFromElement(this.selectedProductEl));},getSelectedProductName:function(){return this.selectedProductEl?this.selectedProductEl.getElement('.name').get('text').trim():'';},isSelectedProductSoldOut:function(){return!this.selectedProductEl.hasClass('sold-out');},selectDefaultProduct:function(){var productEl=this.productEls[0];if(!productEl){return;}
if(productEl.hasClass('unavailable')||productEl.hasClass('sold-out')){var bookableProducts=this.productEls.filter(function(productEl){return!productEl.hasClass('unavailable')&&!productEl.hasClass('sold-out');});if(bookableProducts.length>0){productEl=bookableProducts[0];}else if(this.selectedProductEl.hasClass('unavailable')){var availableProducts=this.productEls.filter(function(productEl){return!productEl.hasClass('unavailable');});if(availableProducts.length>0){productEl=availableProducts[0];}}else{productEl=this.selectedProductEl;}}
this._selectProductEl(productEl);},selectProductById:function(productId){var element=this.rootEl.getElement('#product-'+productId);if(!element){return;}
this._selectProductEl(element);},showAvailability:function(prices,productStates,productOrder,allowStandby){if(productOrder){productOrder.each(function(productId){var matchingProductEls=this.productEls.filter(function(productEl){return(productId==this._getIdFromElement(productEl));}.bind(this));if(matchingProductEls.length>0){var matchingProductEl=matchingProductEls[0];matchingProductEl.inject(matchingProductEl.getParent(),'bottom');this.productEls.splice(this.productEls.indexOf(matchingProductEl),1);this.productEls.push(matchingProductEl);matchingProductEl.removeClass('first-child');}}.bind(this));if(this.productEls.length>0){this.productEls[0].addClass('first-child');}}
this.productEls.each(function(productEl){productEl.removeClass('sold-out').removeClass('unavailable');var productId=this._getIdFromElement(productEl);var price=prices[productId];var productState=productStates[productId];if(!productState||price==null||!productState.isAvailable){if(productState&&productState.reason=='sold out'&&allowStandby){productEl.addClass('sold-out');productEl.getElement('.price').set('html','Standby').removeClass('upd');}else{productEl.addClass('unavailable');}}else{productEl.getElement('.price').set('html',price.averagePrice.formatCurrency()+'/night').removeClass('upd');}
Jetsetter.promoDiscount&&Jetsetter.promoDiscount.fireEvent('update','products');}.bind(this));}});var OccupancyOptions=new Class({Implements:Events,initialize:function(rootEl,options){this.rootEl=rootEl;this.rooms=new Dropdown(this.rootEl.getElement('.rooms select'));this.rooms.addEvent('change',function(numOfRooms){this.updateGuestsDropDown(numOfRooms);this.fireEvent('numOfRoomsChange',numOfRooms);}.bind(this)).set('value',options.numOfRooms);this.guests=new Dropdown(this.rootEl.getElement('.guests select'));this.guests.addEvent('change',function(numOfGuests){this.fireEvent('numOfGuestsChange',numOfGuests);}.bind(this)).set('value',options.numOfGuests);this.updateGuestsDropDown(options.numOfRooms);},rebuildGuests:function(optionsList){var selectEl=this.rootEl.getElement('.guests select');selectEl.empty();for(var i=0;i<optionsList.length;++i){var option=optionsList[i];var selectItemEl=new Element('option',{'value':option,'text':option});selectItemEl.inject(selectEl);}
this.guests.rebuild();},getNumOfRooms:function(){return this.rooms.get('value').toInt();},setNumOfRooms:function(value){this.updateGuestsDropDown(value);this.rooms.set('value',value);},updateGuestsDropDown:function(numOfRooms){var numOfGuests=this.getNumOfGuests();if(numOfRooms>=2){this.rebuildGuests([2,3,4,5,6,7,8]);if(numOfGuests==1){numOfGuests=2;}
this.setNumOfGuests(numOfGuests);}else{this.rebuildGuests([1,2,3,4]);if(numOfGuests>4){numOfGuests=2;}
this.setNumOfGuests(numOfGuests);}},getNumOfGuests:function(){return this.guests.get('value').toInt();},setNumOfGuests:function(value){this.guests.set('value',value);}});var DateFlag=new Class({Implements:Events,initialize:function(targetEl,tooltipHtml){this.targetEl=targetEl;this.container=new Element('div',{'html':'<div class="tooltip-content tenor">'+tooltipHtml+'</div><div class="arrow"></div>','class':'tooltip','styles':{'opacity':0},'morph':{'duration':300,'transition':Fx.Transitions.Quint.easeOut}});this.container.inject(this.targetEl);},_getPosition:function(){var position=this.targetEl.getPosition(this.targetEl.getParent('.monthly-calendar'));var targetElSize=this.targetEl.getSize();position.x-=(this.container.getSize().x.toInt()-targetElSize.x.toInt())/2;position.y-=this.container.getSize().y;return position;},setPosition:function(){if(this.targetEl.getParent('.monthly-calendar')){this.container.setPosition(this._getPosition());}},reveal:function(){var targetPosition=this._getPosition();this.container.setPosition({x:targetPosition.x,y:targetPosition.y-10});this.container.morph({'top':targetPosition.y,'opacity':1});},hide:function(){this.container.get('morph').cancel();this.container.setStyle('display','none');},destroy:function(){this.container.destroy();}});var ProductCalendar2=new Class({Implements:[Events,Options],CHECK_IN_STEP:0,CHECK_OUT_STEP:1,initialize:function(attachTo,tripBuilder){this.attachTo=attachTo;this.tripBuilder=tripBuilder;this.inventory=tripBuilder.inventory;this.occupancy=tripBuilder.occupancy;this.allowStandby=tripBuilder.allowStandby;this.checkin={};this.checkin.minStay;this.tripBuilder.addEvents({'precedingItemSelect':function(selectedStep){if(selectedStep==this.CHECK_IN_STEP){this.deselectCheckInDate();this.deselectCheckOutDate();}else if(selectedStep==this.CHECK_OUT_STEP){this.deselectCheckOutDate();}}.bind(this)});this.checkInEl=attachTo.getElement('#checkin-calendar');this.checkOutEl=attachTo.getElement('#checkout-calendar');this._setCheckInTitle()._showCheckInCalendar();this._setCheckOutTitle()._showCheckOutCalendar();var availableCheckInDates=this.getAvailableCheckInDates();var availableCheckOutDates=this.getAvailableCheckOutDates();var selectedCheckInDate=this.tripBuilder.options.checkInDate;var selectedCheckOutDate=this.tripBuilder.options.checkOutDate;var selectedMonth=this.tripBuilder.options.selectedMonth;var haveSelectedDates=selectedCheckInDate&&selectedCheckOutDate&&availableCheckInDates[selectedCheckInDate.toBookingDateString()]&&availableCheckOutDates[selectedCheckOutDate.toBookingDateString()];var activeMonth=(haveSelectedDates)?selectedCheckInDate.clone().normalize('month'):new Date().normalize('month');var earliestMonth=availableCheckInDates.earliestDate.clone().normalize('month');var latestMonth=availableCheckInDates.latestDate.clone().normalize('month');if(!haveSelectedDates&&selectedMonth){activeMonth=selectedMonth.normalize('month');}
if(activeMonth<earliestMonth){activeMonth=earliestMonth;}else if(activeMonth>latestMonth){activeMonth=latestMonth;}
this.checkInCalendar.selectMonth(activeMonth);this.checkOutCalendar.selectMonth(activeMonth);this.showAvailableCheckInDates(availableCheckInDates);this.showAvailableCheckOutDates(availableCheckOutDates);if(haveSelectedDates){this._selectDates(selectedCheckInDate,selectedCheckOutDate);}},_attachTooltipEvent:function(calendarEl){var isCheckOutCalendar=calendarEl.getParent('#checkout-calendar');calendarEl.addEvents({'mouseover:relay(td)':function(event,dayEl){var dayInventory=dayEl.retrieve('inventory');if(!dayInventory){return false;}
var tooltip=calendarEl.retrieve('tooltip');if(!tooltip){tooltip=new Tooltip(calendarEl.getParent(),{'className':'price-tooltip tenor'});calendarEl.store('tooltip',tooltip);}
var minStay=dayInventory.minStay;var minStayHtml='';if(minStay>1){minStayHtml='<div class="separator"></div><div class="min-stay">Minimum stay:<br>'+minStay+' nights</div>';}
if(dayEl.hasClass('inactive-select')){return;}else{if(isCheckOutCalendar){minStayHtml='';}
tooltip.show('<div class="price">'+dayInventory.price.formatCurrency()+'</div>'+minStayHtml,dayEl,0);Jetsetter.promoDiscount&&Jetsetter.promoDiscount.fireEvent('update','tooltip');}},'mouseout':function(event){var tooltip=calendarEl.retrieve('tooltip');if(tooltip){tooltip.hide();}}});},_createCalendarInstance:function(calendarContainerEl){var calendar=new MonthlyCalendar({monthFormat:'%b'});calendar.addEvents({'dateClick':function(event,element){if(this._isDayAvailable(element)){calendar.toggleSelection(element);}}.bind(this),'dateMouseover':function(event,element){if(this._isDayAvailable(element)){element.addClass('hover');}}.bind(this),'dateMouseout':function(event,element){if(this._isDayAvailable(element)){element.removeClass('hover');}}.bind(this)});return calendar;},_createLegendElement:function(availableLabel){var legendHtml='<li class="available"><span class="icon"></span> '+availableLabel+'</li>';if(this.allowStandby){legendHtml+='<li class="standby"><span class="icon"></span>Standby</li>';}
return new Element('ul',{'class':'legend','html':legendHtml});},_isDayAvailable:function(dayEl){return dayEl.hasClass('available')||(this.allowStandby&&dayEl.hasClass('standby'));},_isDayOnStandby:function(dayEl){return dayEl.hasClass('standby');},_setAvailabilityForDay:function(dayEl,inventory){dayEl.removeClass('min-stay');if(inventory&&inventory.isAvailable){this._setDayToAvailable(dayEl,inventory);}else{this._setDayToUnavailable(dayEl,inventory,arguments[2]);}},_setDayToAvailable:function(dayEl,inventory){dayEl.addClass('available').store('inventory',inventory);if(this.allowStandby){dayEl.removeClass('standby');}},_setDayToUnavailable:function(dayEl,inventory){dayEl.removeClass('available');if(this.allowStandby){if(inventory){dayEl.store('inventory',inventory).addClass('standby');}else{if(!dayEl.hasClass('inactive-select')){dayEl.eliminate('inventory');}
dayEl.removeClass('standby')}}
if(arguments[2]){switch(arguments[2]){case'min-stay':var curText=dayEl.get('text');dayEl.empty();new Element('div',{'class':'indicator','html':curText}).inject(dayEl);dayEl.addClass('min-stay');}}},_setCheckInTitle:function(selectedDate){var accordianTitleEl=this.checkInEl.getElement('.hd');if(selectedDate){var displayDate=selectedDate.format('%b %e %Y');accordianTitleEl.getElement('.text').set('html','Checking in <span class="date">'+displayDate+'</span>');accordianTitleEl.addClass('is-ready');}else{this.checkInEl.getElement('.hd .text').set('html','Select check in date');accordianTitleEl.removeClass('is-ready');}
return this;},_setCheckOutTitle:function(selectedDate){var accordianTitleEl=this.checkOutEl.getElement('.hd');if(selectedDate){var displayDate=selectedDate.format('%b %e %Y');accordianTitleEl.getElement('.text').set('html','Checking out <span class="date">'+displayDate+'</span>');accordianTitleEl.addClass('is-ready');}else{accordianTitleEl.getElement('.text').set('html','Select check out date');accordianTitleEl.removeClass('is-ready');}
return this;},_showCheckInFlag:function(indicatorEl){if(indicatorEl){this._removeCheckInFlag();this.checkInIndicatorEl=indicatorEl;this.checkOutCalendar.markSelectedDate(indicatorEl);var minStay=this.checkInCalendar.getElementFromBookingDate(this.getCheckInDate()).retrieve('inventory').minStay;if(minStay>1){var html='Check in <br/> <br/>'+minStay+' night min';}
else{var html='Check in';}
this.checkInFlag=new DateFlag(indicatorEl,html);setTimeout(function(){this.checkInFlag.reveal();}.bind(this),250);}},_removeCheckInFlag:function(){if(this.checkInIndicatorEl){this.checkOutCalendar.unmarkSelectedDate(this.checkInIndicatorEl);this.checkInIndicatorEl=null;this.checkInFlag.destroy();this.checkInFlag=null;}},_showCheckInCalendar:function(){this.checkInCalendar=this._createCalendarInstance(this.checkInEl);this.checkInCalendar.addEvents({'select':function(selectedDate,selectedEl){omniture.trackFeature('check-in-date-selected');_gaq.push(['_trackEvent','PDP','CheckInDate','Selected']);if(Jetsetter.user.isAnonymous&&Jetsetter.user.isPriceHidden){this.checkInCalendar.deselectDate();Jetsetter.registrationModal.show();return false;}
this.fireEvent('checkInSelectStart',[selectedDate,selectedEl]);var tooltip=$(this.checkInCalendar).retrieve('tooltip');if(tooltip){tooltip.hide();}
this._setCheckInTitle(selectedDate);var checkOutDates=this.getAvailableCheckOutDates();var checkInDayElements=$(this.checkInCalendar).getElements('td').filter(function(element){return this._isDayAvailable(element);},this);var earlistCheckOutDayElement=this.checkInCalendar.getElementFromBookingDate(checkOutDates.earliestDate);var elementsToFade=checkInDayElements.slice(0,checkInDayElements.indexOf(earlistCheckOutDayElement));var startDelay=150;var totalDelay=1000;var delayPillow=-250;var numOfFadeElements=elementsToFade.length;var staggerDelay=totalDelay/(numOfFadeElements*(numOfFadeElements+1)/2);elementsToFade.each(function(cell,index){setTimeout(function(){var morphTo=cell.hasClass('not-in-month')?{'background-color':'#fff','color':'#777'}:{'background-color':'#f0f0f0','color':'#777'};cell.morph(morphTo);},startDelay+index*staggerDelay);});setTimeout(function(){this.checkOutCalendar.selectMonth(checkOutDates.earliestDate);this.showAvailableCheckOutDates(checkOutDates);var checkInIndicatorEl=this.checkOutCalendar.getElementFromBookingDate(selectedDate);this.checkOutCalendar.markSelectedDate(checkInIndicatorEl);this.tripBuilder.display(this.CHECK_OUT_STEP,true).chain(function(){this.checkInCalendar.selectMonth(checkOutDates.earliestDate);this.showAvailableCheckInDates();elementsToFade.each(function(el){el.set('style','');});this._showCheckInFlag(checkInIndicatorEl);this.fireEvent('checkInSelectComplete',[selectedDate,selectedEl]);}.bind(this));}.bind(this),startDelay+totalDelay+delayPillow);}.bind(this),'monthChange':function(activeMonth){this.checkOutCalendar.selectMonth(activeMonth);this.showAvailableCheckInDates();this.fireEvent('monthChange');}.bind(this)});this.checkInEl.getElement('.bd').adopt($(this.checkInCalendar),this._createLegendElement('Available check in dates'));if(!this.tripBuilder.property.connectivityFPRateEnabled){this._attachTooltipEvent($(this.checkInCalendar));}},_showCheckOutCalendar:function(){this.checkOutCalendar=this._createCalendarInstance(this.checkOutEl);this.checkOutCalendar.addEvents({'select':function(selectedDate,selectedEl){omniture.trackFeature('check-out-date-selected');_gaq.push(['_trackEvent','PDP','CheckOutDate','Selected']);this.fireEvent('checkOutSelectStart',[selectedDate,selectedEl]);var tooltip=$(this.checkOutCalendar).retrieve('tooltip');if(tooltip){tooltip.hide();}
this._setCheckOutTitle(selectedDate);this.showAvailableCheckInDates();setTimeout(function(){this.tripBuilder.display(this.tripBuilder.OPTIONS_STEP,true);}.bind(this),500);}.bind(this),'monthChange':function(activeMonth){this.checkInCalendar.selectMonth(activeMonth);this.showAvailableCheckOutDates();if(this.checkInIndicatorEl){this.checkInFlag.setPosition();}}.bind(this)});this.checkOutEl.getElement('.bd').adopt($(this.checkOutCalendar),this._createLegendElement('Available check out dates'));if(!this.tripBuilder.property.connectivityFPRateEnabled){this._attachTooltipEvent($(this.checkOutCalendar));}},deselectCheckInDate:function(){this.checkInCalendar.deselectDate();this._setCheckInTitle();this.showAvailableCheckOutDates();this._removeCheckInFlag();this.fireEvent('checkInDeselect');},deselectCheckOutDate:function(){this.checkOutCalendar.deselectDate();this._setCheckOutTitle();this.showAvailableCheckInDates();this.fireEvent('checkOutDeselect');},getCheckInDate:function(){return this.checkInCalendar&&this.checkInCalendar.getSelectedDate()||null;},setCheckInDate:function(checkInDate){var dayEl=this.checkInCalendar.getElementFromBookingDate(checkInDate);if(!dayEl){return;}
this.checkInCalendar.selectDate(dayEl);},isCheckInDateOnStandby:function(){var checkInDate=null;if(this.checkInCalendar&&(checkInDate=this.checkInCalendar.getSelectedDate())){var dayEl=this.checkInCalendar.getElementFromBookingDate(checkInDate);return this._isDayOnStandby(dayEl);}
return false;},getCheckOutDate:function(){return this.checkOutCalendar&&this.checkOutCalendar.getSelectedDate()||null;},setCheckOutDate:function(checkOutDate){var dayEl=this.checkOutCalendar.getElementFromBookingDate(checkOutDate);if(!dayEl){return;}
this.checkOutCalendar.selectDate(dayEl);},isCheckOutDateOnStandby:function(){var checkOutDate=null;if(this.checkOutCalendar&&(checkOutDate=this.checkOutCalendar.getSelectedDate())){var dayEl=this.checkOutCalendar.getElementFromBookingDate(checkOutDate);return this._isDayOnStandby(dayEl);}
return false;},getAvailableCheckInDates:function(){this.availableCheckInDates=this.inventory.getAvailableCheckInDates(this.getCheckOutDate(),this.occupancy.getNumOfRooms());if(!this.allowStandby){this.trimAvailableDates(this.availableCheckInDates);}
return this.availableCheckInDates;},getAvailableCheckOutDates:function(){this.availableCheckOutDates=this.inventory.getAvailableCheckOutDates(this.getCheckInDate(),this.occupancy.getNumOfRooms());if(!this.allowStandby){this.trimAvailableDates(this.availableCheckOutDates);}
return this.availableCheckOutDates;},getLowestPrice:function(){var lowestPrice=null;var lowestMarketPrice=null;var activeMonth=this.checkInCalendar.getActiveMonth();Object.each(this.availableCheckInDates,function(availableDate,key){var date=key.toDateObject();if(date&&date.getMonth()==activeMonth.getMonth()&&date.getFullYear()==activeMonth.getFullYear()){var price=parseFloat(availableDate.price);if(price&&(lowestPrice==null||lowestPrice>price)){lowestPrice=price;lowestMarketPrice=parseFloat(availableDate.marketPrice);}}},this);return{price:Math.ceil(lowestPrice),marketPrice:Math.ceil(lowestMarketPrice)};},_selectDates:function(checkInDate,checkOutDate){var checkInDayEl=this.checkInCalendar.getElementFromBookingDate(checkInDate);var checkOutDayEl=this.checkOutCalendar.getElementFromBookingDate(checkOutDate);if(this._isDayAvailable(checkInDayEl)&&this._isDayAvailable(checkOutDayEl)){this.checkInCalendar.selectDate(checkInDayEl);this._setCheckInTitle(checkInDate);this.checkOutCalendar.selectDate(checkOutDayEl);this._setCheckOutTitle(checkOutDate);this.fireEvent('checkOutSelectStart',[checkOutDate,checkOutDayEl]);}},showAvailableCheckInDates:function(checkInDates){checkInDates=checkInDates||this.getAvailableCheckInDates();this.checkInCalendar.updateControls(checkInDates.earliestDate,checkInDates.latestDate);$(this.checkInCalendar).getElements('td').each(function(dayEl){var bookingDate=dayEl.retrieve('bookingDate');var dayInventory=checkInDates[bookingDate.toBookingDateString()];this._setAvailabilityForDay(dayEl,dayInventory);}.bind(this));},showAvailableCheckOutDates:function(checkOutDates){var checkInDate=this.getCheckInDate(),consec=false,minStay=0;checkOutDates=checkOutDates||this.getAvailableCheckOutDates()
this.checkOutCalendar.updateControls(checkOutDates.earliestDate,checkOutDates.latestDate);if(checkInDate){if(this.checkInCalendar.getElementFromBookingDate(checkInDate).retrieve('inventory')){minStay=this.checkInCalendar.getElementFromBookingDate(checkInDate).retrieve('inventory').minStay;this.checkin.minStay=minStay;}
else{minStay=this.checkin.minStay;}}
$(this.checkOutCalendar).getElements('td').each(function(dayEl){var bookingDate=dayEl.retrieve('bookingDate');var dayInventory=checkOutDates[bookingDate.toBookingDateString()];if(checkInDate&&checkInDate.diff(bookingDate)>0){consec=true;}
if(!dayInventory&&consec&&checkInDate&&checkInDate.diff(bookingDate)>0&&checkInDate.diff(bookingDate)<minStay){this._setAvailabilityForDay(dayEl,dayInventory,'min-stay');}
else{this._setAvailabilityForDay(dayEl,dayInventory);consec=false;}}.bind(this));},trimAvailableDates:function(availableDates){var availableKeys=Object.keys(availableDates).sort();var trim=function(){for(var i=availableKeys.length-1;i>0;i--){var key=availableKeys[i];if(availableDates[key].isAvailable){break;}else{availableKeys.pop();delete availableDates[key];}}};trim();availableKeys.reverse();trim();availableDates.earliestDate=availableKeys[availableKeys.length-1].toDateObject();availableDates.latestDate=availableKeys[0].toDateObject();return availableDates;}});var TripBuilder2=new Class({Extends:Fx.Accordion,options:{checkInDate:null,checkOutDate:null,numOfRooms:1,numOfGuests:2},state:{},initialize:function(attachTo,property,eventId,options){this.attachTo=attachTo;this.property=property;options.numOfGuests=options.numOfGuests||this._getMinNumOfGuests();this.setOptions(options);this.parent([],[],{display:-1,opacity:false,duration:500,transition:Fx.Transitions.Quint.easeInOut});this.addEvents({'active':function(toggler,element){this.updateProductOptionsTitle();toggler.addClass('hd-open');}.bind(this),'background':function(toggler,element){toggler.removeClass('hd-open');element.setStyles({'overflow':'hidden'});},'complete':function(){var openAccordionItem=this.elements[this.previous];openAccordionItem.setStyle('overflow','visible');if(this.previous==this.OPTIONS_STEP){openAccordionItem.setStyle('height','auto');}
this._hideClickShield();}.bind(this)});this.allowStandby=!Jetsetter.disableStandby;this.allowHold=!Jetsetter.disableHold;this.calendarType=property.calendarType;this.inventory=new Inventory(property.propertyId,eventId);this.inventory.addEvents({'ready':function(){this.updateProductOptionsTitle();this.renderCalendar();if(!this.inventory.isAvailable(options)){var noInventoryBanner=this.inventory.getNoInventoryBanner();noInventoryBanner.hide();noInventoryBanner.inject($('page-content'),'before');var noInventoryReveal=new Fx.Reveal(noInventoryBanner,{'duration':200});noInventoryReveal.reveal();}}.bind(this),'pricingReady':function(){this._updateProductPrices();this.productTypes.selectDefaultProduct();this.updatePricing();this.updateSubtotal();this._hidePricingOverlay();}.bind(this),'pricingError':function(){this.display(0);new NotificationModal('There are no rooms available for the dates selected. Please choose different dates','error').show();}.bind(this)});var productTypesEl=$('product-types');if(productTypesEl){this.productTypes=new ProductTypes(productTypesEl);this.productTypes.addEvent('productChange',function(productId){this.updateProductOptionsTitle();this.saveState();this.updateSubtotal();this.enableOrderForm();this.fireEvent('productChange',productId);}.bind(this));}
this.occupancy=new OccupancyOptions($('occupancy'),{numOfRooms:this.options.numOfRooms,numOfGuests:this.options.numOfGuests});this.occupancy.addEvent('numOfRoomsChange',function(){var checkInDate=this.getCheckInDate();var checkOutDate=this.getCheckOutDate();var numOfRooms=this.occupancy.getNumOfRooms().toInt();var numOfGuests=this.occupancy.getNumOfGuests().toInt();var productStates=this.inventory.getProductStatesFromPricing(checkInDate,checkOutDate,numOfRooms,numOfGuests);var productStatesPrev=this.inventory.getProductStatesFromPricing(checkInDate,checkOutDate,this.state.numOfRooms,numOfGuests);var selectedProductId=this.getSelectedProductId();if(productStatesPrev[selectedProductId].isAvailable&&!productStates[selectedProductId].isAvailable){if(productStates[selectedProductId].reason=='sold out'){this._handleUnavailableForInventory(checkInDate,checkOutDate,numOfRooms,numOfGuests,selectedProductId,productStates);}else if(productStates[selectedProductId].reason=='max occupancy'){this._handleUnavailableForOccupancy(checkInDate,checkOutDate,numOfRooms,numOfGuests,selectedProductId,productStates);}}else{this._updateProducts(productStates);}}.bind(this));this.occupancy.addEvent('numOfGuestsChange',function(){var checkInDate=this.getCheckInDate();var checkOutDate=this.getCheckOutDate();var numOfRooms=this.occupancy.getNumOfRooms();var numOfGuests=this.occupancy.getNumOfGuests();var productStates=this.inventory.getProductStatesFromPricing(checkInDate,checkOutDate,numOfRooms,numOfGuests);var productStatesPrev=this.inventory.getProductStatesFromPricing(checkInDate,checkOutDate,numOfRooms,this.state.numOfGuests);var selectedProductId=this.getSelectedProductId();var wasStandby=(!productStatesPrev[selectedProductId].isAvailable&&productStatesPrev[selectedProductId].reason=='sold out');if((productStatesPrev[selectedProductId].isAvailable||wasStandby)&&!productStates[selectedProductId].isAvailable){this._handleUnavailableForOccupancy(checkInDate,checkOutDate,numOfRooms,numOfGuests,selectedProductId,productStates,wasStandby);}else{this._updateProducts(productStates);}}.bind(this));this.orderForm=this.attachTo.getElement('#order form');this.bookButton=this.orderForm.getElement('.book-button').set('disabled',false);this.bookButton.addEvent('click',function(){this.bookButton.set('disabled',true);if(!this.submitOrder('order')){this.bookButton.set('disabled',false);}}.bind(this));if(this.allowHold){var holdTooltip=null;this.holdButton=this.orderForm.getElement('.hold-button');this.holdButton.addEvents({'click':function(){this.holdButton.set('disabled',true);if(!this.submitOrder('hold')){this.holdButton.set('disabled',false);}}.bind(this),'mouseenter':function(){holdTooltip=holdTooltip||new Tooltip(this.attachTo,{'className':'order-tooltip tenor'});var holdTooltipText='If you need more time, hold this trip for the next 72 hours for 10% of the price. If you buy, the hold payment is applied to your purchase. If not, your hold will be refunded as a Jetsetter credit.';holdTooltip.show(holdTooltipText,this.holdButton,150);}.bind(this),'mouseleave':function(){holdTooltip.hide();}});}
if(this.allowStandby){var standbyTooltip=null;this.standbyButton=this.orderForm.getElement('.standby-button');this.standbyButton.addEvents({'click':function(){this.standbyButton.set('disabled',true);if(!this.submitOrder('standby')){this.standbyButton.set('disabled',false);}}.bind(this),'mouseenter':function(){standbyTooltip=standbyTooltip||new Tooltip(this.attachTo,{'className':'order-tooltip tenor'});var standbyTooltipText='One or more of the dates you’ve selected are sold out, but they may become available again before this sale ends. If you make a standby reservation, we’ll automatically book you at the same rate if the dates open up.';standbyTooltip.show(standbyTooltipText,this.standbyButton,150);}.bind(this),'mouseleave':function(){standbyTooltip.hide();}});}
this.addEvent('orderReady',function(){}.bind(this));this.addEvent('orderUndo',function(){this.inventory.clearPricing();this.updateSubtotal();this.resetOrderForm();}.bind(this));},_getMinNumOfGuests:function(){return _.reduce(Jetsetter.products,function(min,product){return Math.min(product.maxOccupancy,min);},this.options.numOfGuests);},_handleUnavailableForInventory:function(checkInDate,checkOutDate,numOfRooms,numOfGuests,selectedProductId,productStates){var message=this.allowStandby?'This room type isn’t available in the quantity you want, but more rooms could open up before this sale ends. If you make a Standby reservation, we’ll automatically book you at the same rate if that happens.':'This room type isn’t available in the quantity you want.';var decisionModal=new DecisionModal(this.attachTo,message,this);decisionModal.addEvent('cancel',function(){this.revertState();}.bind(this));var productStatesAvailable=Object.filter(productStates,function(productState){return productState.isAvailable;});if(Object.getLength(productStatesAvailable)>0){var productId=Object.keys(productStatesAvailable)[0];if(Jetsetter.products[productId]){decisionModal.addButton('Change to '+Jetsetter.products[productId].name,function(){this.productTypes.selectProductById(Object.keys(productStatesAvailable)[0]);this._updateProducts(productStates);}.bind(this));}}
if(this.allowStandby){decisionModal.addButton('Go on Standby',function(){this._updateProducts(productStates);}.bind(this));}
decisionModal.show();},_handleUnavailableForOccupancy:function(checkInDate,checkOutDate,numOfRooms,numOfGuests,selectedProductId,productStates,wasStandby){var decisionModal=new DecisionModal(this.attachTo,'Your number of guests exceeds the maximum occupancy for your room selection.',this);decisionModal.addEvent('cancel',function(){this.revertState();}.bind(this));var productStatesAvailable=Object.filter(productStates,function(productState){return productState.isAvailable;});for(var suggestedNumOfRooms=2;suggestedNumOfRooms<=4;suggestedNumOfRooms++){var productStatesExtraRoom=this.inventory.getProductStatesFromPricing(checkInDate,checkOutDate,suggestedNumOfRooms,numOfGuests);var productStatesExtraRoomAvailable=Object.filter(productStatesExtraRoom,function(productState){return productState.isAvailable;});if(productStatesExtraRoom[selectedProductId].isAvailable){if(Jetsetter.products[selectedProductId]){decisionModal.addButton('Book '+suggestedNumOfRooms+' '+Jetsetter.products[selectedProductId].name+'s',function(){this.occupancy.setNumOfRooms(suggestedNumOfRooms);this._updateProducts(productStatesExtraRoom);}.bind(this));decisionModal.show();return;}}else if(Object.getLength(productStatesAvailable)>0){var productId=Object.keys(productStatesAvailable)[0];if(Jetsetter.products[productId]){decisionModal.addButton('Change to '+numOfRooms+' '+Jetsetter.products[productId].name+(numOfRooms>1?'s':''),function(){this.productTypes.selectProductById(Object.keys(productStatesAvailable)[0]);this._updateProducts(productStates);}.bind(this));decisionModal.show();return;}}else if(Object.getLength(productStatesExtraRoomAvailable)>0){var productId=Object.keys(productStatesExtraRoomAvailable)[0];if(Jetsetter.products[productId]){decisionModal.addButton('Change to '+suggestedNumOfRooms+' '+Jetsetter.products[productId].name+'s',function(){this.productTypes.selectProductById(Object.keys(productStatesExtraRoomAvailable)[0]);this.occupancy.setNumOfRooms(suggestedNumOfRooms);this._updateProducts(productStatesExtraRoom);}.bind(this));decisionModal.show();return;}}}
var suggestedNumOfRooms=Math.ceil(numOfGuests/Jetsetter.products[selectedProductId].maxOccupancy);if(wasStandby){if(suggestedNumOfRooms<=numOfRooms){return;}
decisionModal.addButton('Change to '+suggestedNumOfRooms+' '+Jetsetter.products[selectedProductId].name+'s',function(){this.occupancy.setNumOfRooms(suggestedNumOfRooms);this._updateProducts(productStatesExtraRoom);}.bind(this));decisionModal.show();return;}
decisionModal.show();},_updateProducts:function(productStates){var checkInDate=this.getCheckInDate();var checkOutDate=this.getCheckOutDate();var numOfRooms=this.occupancy.getNumOfRooms();var productPrices=this.inventory.getProductPrices(checkInDate,checkOutDate,numOfRooms);var productOrder=this.inventory.getProductOrder();this.productTypes.showAvailability(productPrices,productStates,productOrder,this.allowStandby);this.updateProductOptionsTitle();this.updateSubtotal();this.enableOrderForm();this.saveState();},_showClickShield:function(){this.clickShield=this.clickShield||new Element('div',{'class':'click-shield'}).inject(this.attachTo);this.clickShield.show();},_hideClickShield:function(){if(this.clickShield){this.clickShield.hide();}},_showPricingOverlay:function(){this.pricingOverlay=this.pricingOverlay||(function(){var paddingBottom=this.attachTo.getElement('#order').getSize().y;var overlayContainerEl=new Element('div',{'class':'pricing-overlay','html':'<div class="overlay"></div> <div class="spinner tenor">Updating prices…</div>'}).setStyle('paddingBottom',paddingBottom);return overlayContainerEl.adopt(overlayEl).inject($('product-options').getElement('.bd'));}.bind(this))();this.pricingOverlay.show();var overlayEl=this.pricingOverlay.getElement('.overlay');overlayEl.set('opacity',0.5);},_hidePricingOverlay:function(){var overlayEl=this.pricingOverlay.getElement('.overlay');this.pricingOverlay.hide();overlayEl.get('tween').start('opacity',0);},display:function(selectedIndex,isNextStep){if(selectedIndex<0){return this;}
var openIndex=this.previous;if(!isNextStep&&openIndex>-1&&selectedIndex>=openIndex){return this;}
if(selectedIndex<openIndex){this.fireEvent('precedingItemSelect',selectedIndex);}
this.parent(selectedIndex);return this;},getCheckInDate:function(){return(this.calendar&&this.calendar.getCheckInDate())||null;},getCheckOutDate:function(){return(this.calendar&&this.calendar.getCheckOutDate())||null;},getSelectedProductId:function(){return(this.productTypes&&this.productTypes.getSelectedId())||null;},renderCalendar:function(){var calendarContainerEl=$('calendar');var firstStep=0;if(this.calendarType=='package'){this.OPTIONS_STEP=1;this.calendar=new PackageCalendar2(calendarContainerEl,this);}else{this.OPTIONS_STEP=2;this.calendar=new ProductCalendar2(calendarContainerEl,this).addEvents({'checkInSelectStart':function(){this._showClickShield();}.bind(this),'checkInSelectComplete':function(){this._hideClickShield();this.saveState();}.bind(this),'checkOutSelectStart':function(){this._showClickShield();this.updateProductOptionsTitle();}.bind(this),'checkOutSelectComplete':function(){this.getPricing();this._hideClickShield();this.fireEvent('orderReady');this.saveState();}.bind(this),'checkOutDeselect':function(){this.saveState();this.fireEvent('orderUndo');}.bind(this),'monthChange':function(){this.updatePricing();}.bind(this)});this.addEvents({'complete':function(){if(this.OPTIONS_STEP==this.previous){this.calendar.fireEvent('checkOutSelectComplete');}}.bind(this)});this.updatePricing();if(this.calendar.getCheckInDate()&&this.calendar.getCheckOutDate()){firstStep=this.OPTIONS_STEP;}}
var togglerEls=this.attachTo.getElements('.hd');var contentEls=this.attachTo.getElements('.bd');for(var i=0;i<togglerEls.length;i++){this.addSection(togglerEls[i],contentEls[i],i);}
this.display(firstStep,true);},enableOrderForm:function(){this.resetOrderForm();if(this.allowStandby&&!this.productTypes.isSelectedProductSoldOut()){this.orderForm.addClass('standby');this.standbyButton.set('disabled',false);}else{this.bookButton.set('disabled',false);if(this.allowHold){var firstAvailableHoldDate=this.inventory.getFirstAvailableHoldDate(this.getSelectedProductId());if(this.getCheckInDate()<firstAvailableHoldDate){this.orderForm.removeClass('hold');}else{this.orderForm.addClass('hold');this.holdButton.set('disabled',false);}
this.orderForm.removeClass('standby');}}},resetOrderForm:function(){if(this.allowHold){this.orderForm.removeClass('hold');}
if(this.allowStandby){this.orderForm.removeClass('standby');}},getPricing:function(){this._showPricingOverlay();var checkInDate=this.getCheckInDate();var checkOutDate=this.getCheckOutDate();this.inventory.getPricing(checkInDate,checkOutDate);},_updateProductPrices:function(){var checkInDate=this.getCheckInDate();var checkOutDate=this.getCheckOutDate();var numOfRooms=this.occupancy.getNumOfRooms();var numOfGuests=this.occupancy.getNumOfGuests();var productPrices=this.inventory.getProductPrices(checkInDate,checkOutDate,numOfRooms);var productOrder=this.inventory.getProductOrder();var productStates=this.inventory.getProductStatesFromPricing(checkInDate,checkOutDate,numOfRooms,numOfGuests);this.productTypes.showAvailability(productPrices,productStates,productOrder,this.allowStandby);this.enableOrderForm();},updateProductOptionsTitle:function(){var headerEl=$('product-options').getElement('.hd'),currentPromo=this._getCurrentPromotion(),displayText='';headerEl.removeEvents();if(currentPromo&&this.getCheckInDate()&&this.getCheckOutDate()){displayText=currentPromo.description;headerEl.addClass('promo-show');if(currentPromo.publicDescription){var tooltip=new ProductPromoTooltip(headerEl,currentPromo);headerEl.addEvents({'mouseenter':function(event){tooltip.show(headerEl,100);},'mouseleave':function(){tooltip.hide();}});}}else{var numOfRooms=this.occupancy.getNumOfRooms();var numOfGuests=this.occupancy.getNumOfGuests();var productName=this.productTypes.getSelectedProductName();if(productName){if(numOfRooms>1){displayText=numOfRooms+' × '+productName.truncate(18);}else{displayText=productName.truncate(21);}}
if(numOfGuests>0){if(productName){displayText+=', ';}
displayText+=numOfGuests+' '+'guest'+((numOfGuests>1)?'s':'');}
headerEl.removeClass('promo-show');}
headerEl.getElement('.text').set('text',displayText);},_getCurrentPromotion:function(){var checkInDate=this.getCheckInDate();var modeToInt={'flash':1,'retail':2}
var promo=null;Jetsetter.property.pricingRules.some(function(pricingRule){var now=new Date();var roomTypes=pricingRule.criteria.RT;var roomTypesArray=_.isArray(roomTypes)?roomTypes:[];roomTypesArray=_.map(roomTypesArray,function(rt){return parseInt(rt);});if((!roomTypesArray.length||_.contains(roomTypesArray,this.getSelectedProductId()))&&(!pricingRule.criteria.BDL||pricingRule.criteria.BDL.toDateObject()>now)&&(!pricingRule.criteria.BDG||pricingRule.criteria.BDG.toDateObject()<now)&&(!pricingRule.criteria.PT||pricingRule.criteria.PT==modeToInt[Jetsetter.property.mode])&&(!pricingRule.criteria.TDL||(checkInDate&&pricingRule.criteria.TDL.toDateObject()>checkInDate))&&(!pricingRule.criteria.TDG||pricingRule.criteria.TDG.toDateObject()<checkInDate)&&(!pricingRule.criteria.AP||(checkInDate&&pricingRule.criteria.AP<now.diff(checkInDate,'day')))&&(!pricingRule.criteria.DOA||(checkInDate&&pricingRule.criteria.DOA==checkInDate.get('day')))){promo=pricingRule;return true;}else{return false;}},this);return promo;},updatePricing:function(){var lowestPrice=this.calendar.getLowestPrice();var pricingEl=$('product-pricing');var compareEl=pricingEl.getElement('.compare');var selectedProductId=this.productTypes.getSelectedId();var pricing=this.inventory.getPricingObjectForProductId(selectedProductId);if(document.location.search.match(/checkin=\d{8}/)&&document.location.search.match(/checkout=\d{8}/)){if(pricing){pricingEl.show();pricingEl.getElement('.txtfrom').hide();pricingEl.getElement('.our-price .price').set('html',pricing.avgPrice.formatCurrency()).removeClass('upd');}}else{pricingEl.show();pricingEl.getElement('.txtfrom').show();pricingEl.getElement('.our-price .price').set('html',lowestPrice.price.formatCurrency()).removeClass('upd');if(compareEl){var productId=this.getSelectedProductId();if(Jetsetter.products[productId]&&Jetsetter.products[productId].exclusive){compareEl.addClass('exclusive').removeClass('other-price');compareEl.set('html','Only on Jetsetter');}else if(lowestPrice.price==lowestPrice.marketPrice){compareEl.addClass('other-price').removeClass('exclusive');compareEl.set('html','');}else{compareEl.addClass('other-price').removeClass('exclusive');var str=Jetsetter.property.calendarType==='package'?'Actual Value':'Hotel website';compareEl.set('html',str+' <del>'+lowestPrice.marketPrice.formatCurrency()+'/night</del>');}}}
Jetsetter.promoDiscount&&Jetsetter.promoDiscount.fireEvent('update','our-price');},updateSubtotal:function(){var checkInDate=this.getCheckInDate();var checkOutDate=this.getCheckOutDate();var selectedProductId=this.productTypes.getSelectedId();if(!checkInDate||!checkOutDate||!selectedProductId){this.attachTo.getElement('#subtotal .value').set('html',(0).formatCurrency());return;}
var totalPrice=this.inventory.getSubtotalForProductFromPricing(selectedProductId);var pricing=this.inventory.getPricingObjectForProductId(selectedProductId);var numOfRooms=this.occupancy.getNumOfRooms();totalPrice*=numOfRooms;var subtotalValueEl=this.attachTo.getElement('#subtotal .value').removeClass('upd');var discountedPrice=Jetsetter.promoDiscount?Jetsetter.promoDiscount.getDiscountedTotal(totalPrice):totalPrice;var priceTween=new Fx.PriceTween(subtotalValueEl).start(discountedPrice).chain(function(){Jetsetter.promoDiscount&&Jetsetter.promoDiscount.fireEvent('update','subtotal');});var subtotal=0;Object.each(pricing.dates,function(value,key){subtotal+=value.marketPrice;});subtotal*=numOfRooms;var discountPercentage=((subtotal-discountedPrice)/subtotal)*100;this.fireEvent('updateSubtotal',[subtotal,discountedPrice]);},submitOrder:function(mode){if(!Jetsetter.user.publicCheckout&&Jetsetter.user.isAnonymous&&Jetsetter.user.isPriceHidden){Jetsetter.registrationModal.show();return false;}
var checkInDate=this.getCheckInDate();var checkOutDate=this.getCheckOutDate();var selectedProductId=this.productTypes.getSelectedId();this.orderTooltip=this.orderTooltip||new Tooltip(this.attachTo,{'className':'order-tooltip tenor'});if(!checkInDate||!checkOutDate){var message='Please select a check '+(!checkInDate?'in':'out')+' date above.';this.orderTooltip=(this.orderTooltip||new Tooltip(this.attachTo,{'className':'order-tooltip tenor'})).show(message,this.bookButton);return false;}
var order={ids:this.inventory.getInventoryIdsForOrder(checkInDate,checkOutDate,selectedProductId),quantity:this.occupancy.getNumOfRooms(),numOfGuests:this.occupancy.getNumOfGuests(),ratePlanId:this.inventory.getRatePlanIdForProductId(selectedProductId)};if(mode=='order'){var orderCheckout=function(){var inventoryService=new InventoryService();inventoryService.isInventoryAvailable({inventoryIds:order.ids,quantity:order.quantity,onSuccess:function(data){var queryParams={items:order.ids.join(','),quantity:order.quantity,numAdults:order.numOfGuests};queryParams.mode=(this.property.requiresApproval)?'deferredbooking':'order';Object.merge(queryParams,Jetsetter.user.affiliateParams);location=Jetsetter.SECURE_HOST+'/checkout?'+Object.toQueryString(queryParams);}.bind(this),onFailure:function(code,message){this.bookButton.set('disabled',false).set('text','Select');new NotificationModal(message,'error').show();throw new Error("ERROR "+code+": "+message);}.bind(this)});}.bind(this);if((Jetsetter.user.publicCheckout&&!Jetsetter.user.hasGuid())||(Jetsetter.property.mode==='retail'&&Jetsetter.user.isPublic)){orderCheckout();}else{Jetsetter.secureLogin(Object.merge({dismissOnLogin:true,onModalShow:function(){omniture.trackFeature('secure-login-modal-show');_gaq.push(['_trackEvent','Modal','OrderSecureLogin','Show']);}.bind(this),onCloseEnd:function(){this.bookButton.set('disabled',false).set('text','Select');}.bind(this),onLogin:function(){orderCheckout();}.bind(this),setScreen:Jetsetter.user.hasIdentity?'SecureLogin':'CreatePassword'},Jetsetter.anonymousBrowse&&Jetsetter.anonymousBrowse.options.promoId?{promoId:Jetsetter.anonymousBrowse.options.promoId}:{}));}}else if(mode=='hold'){Jetsetter.secureLogin(Object.merge({onModalShow:function(){omniture.trackFeature('secure-login-modal-show');_gaq.push(['_trackEvent','Modal','HoldSecureLogin','Show']);}.bind(this),onCloseEnd:function(){this.holdButton.set('disabled',false);}.bind(this),onLogin:function(){new OrderService().getCountOfActiveHolds({onSuccess:function(count){if(count>=3){var notificationModal=new NotificationModal('Oops! Jetsetter allows a maximum of three active holds at a time. Please contact Customer Support if you have questions.','error');notificationModal.show();}else{this.orderForm.getElement('input[name=input]').set('value',JSON.encode(order));this.orderForm.set('action',Jetsetter.SECURE_HOST+'/checkout?mode=hold').submit();}}.bind(this),onFailure:function(){this.holdButton.set('disabled',false);}.bind(this)});}.bind(this),setScreen:Jetsetter.user.hasIdentity?'SecureLogin':'CreatePassword'},Jetsetter.anonymousBrowse&&Jetsetter.anonymousBrowse.options.promoId?{promoId:Jetsetter.anonymousBrowse.options.promoId}:{}));}else if(mode=='standby'){Jetsetter.secureLogin(Object.merge({onModalShow:function(){omniture.trackFeature('secure-login-modal-show');_gaq.push(['_trackEvent','Modal','StandBySecureLogin','Show']);}.bind(this),onCloseEnd:function(){this.standbyButton.set('disabled',false);}.bind(this),onLogin:function(){location=Jetsetter.SECURE_HOST+'/checkout?mode=standby&inventory-ids='+order.ids.join(',')+'&quantity='+order.quantity;},setScreen:Jetsetter.user.hasIdentity?'SecureLogin':'CreatePassword'},Jetsetter.anonymousBrowse&&Jetsetter.anonymousBrowse.options.promoId?{promoId:Jetsetter.anonymousBrowse.options.promoId}:{}));}
return true;},saveState:function(){this.state={checkInDate:this.getCheckInDate(),checkOutDate:this.getCheckOutDate(),productId:this.getSelectedProductId(),numOfRooms:this.occupancy.getNumOfRooms(),numOfGuests:this.occupancy.getNumOfGuests()};},revertState:function(){if(this.state.checkInDate){this.calendar.setCheckInDate(this.state.checkInDate);}else{this.calendar.deselectCheckInDate();}
if(this.state.checkOutDate){this.calendar.setCheckOutDate(this.state.checkOutDate);}else{this.calendar.deselectCheckOutDate();}
if(this.state.productId){this.productTypes.selectProductById(this.state.productId)}else{this.productTypes.selectDefaultProduct();}
if(this.state.numOfRooms){this.occupancy.setNumOfRooms(this.state.numOfRooms);}else{this.occupancy.setNumOfRooms(this.options.numOfRooms);}
if(this.state.numOfGuests){this.occupancy.setNumOfGuests(this.state.numOfGuests);}else{this.occupancy.setNumOfGuests(this.options.numOfGuests);}}});var VoucherSelector=new Class({Extends:Fx.Accordion,initialize:function(attachTo,propertyId,eventId){this.attachTo=attachTo;var voucherEls=this.attachTo.getElements('.voucher');this.ProductService=new ProductService();this.ProductService.getVouchersForItem({propertyId:propertyId,eventId:eventId,onSuccess:function(data){var vouchers=data;Object.each(vouchers,function(voucher){var voucherEl=$('voucher-'+voucher.eventVoucherId);if(voucher.expertMode){voucherEl.addClass('expert');}
if(voucher.amountAvailable<=0){voucherEl.addClass('sold-out');if(voucherEl.hasClass('selected')){voucherEl.removeClass('selected').addClass('sold-out-selected');}
voucherEl.getElements('p.limit')?voucherEl.getElements('p.limit').hide():null;voucherEl.getElement('p.sold-out-text').show();}else{var selectEl=voucherEl.getElement('select')
var selectProxyEl=voucherEl.getElement('.select-proxy');var numOfAvailableVouchers=Math.min(Jetsetter.voucher.voucherRestrictionCount,5);if(numOfAvailableVouchers==1){voucherEl.getElement('.quantity').hide();}else{for(var i=1;i<=numOfAvailableVouchers;i++){var optionEl=new Element('option',{'value':i,'text':i});optionEl.inject(selectEl);}}
var dropdown=new Dropdown(selectEl,selectProxyEl);dropdown.addEvent('change',function(selectedValue){this.updateOrderForm();}.bind(this));if(Browser.ie6||Browser.ie7){selectProxyEl.hide();}
voucherEl.store('dropdown',dropdown);}
this.selectVoucher(voucherEls[0]);setTimeout(function(){this.display(0);}.bind(this),0);},this);}.bind(this),onFailure:function(){}.bind(this)})
this.parent(voucherEls,this.attachTo.getElements('.collapsible'),{duration:500,transition:Fx.Transitions.Quint.easeInOut,opacity:false,display:-1});this.addEvents({'background':function(toggler,element){element.setStyles({'overflow':'hidden'});if(Browser.ie6||Browser.ie7){element.getElement('.select-proxy').hide();}},'complete':function(){this.updateOrderForm();var accordionEl=this.elements[this.previous]
accordionEl.setStyle('overflow','visible');if(Browser.ie6||Browser.ie7){accordionEl.getElement('.select-proxy').show();}}});this.attachTo.addEvents({'click:relay(.voucher)':function(event,element){if(!element.hasClass('selected')){this.selectVoucher(element);}}.bind(this),'mouseover:relay(.voucher)':function(event,element){element.addClass('hover');}.bind(this),'mouseout:relay(.voucher)':function(event,element){element.removeClass('hover');}.bind(this)});this.orderForm=this.attachTo.getElement('#order form');this.bookButton=this.orderForm.getElement('.book-button');this.bookButton.addEvent('click',function(event){this.bookButton.set('disabled',true).addClass('disabled');if(!this.submitOrder('order')){this.bookButton.set('disabled',false).removeClass('disabled');}}.bind(this));this.standbyButton=this.orderForm.getElement('.standby-button');this.standbyButton.addEvent('click',function(event){this.standbyButton.set('disabled',true).addClass('disabled');if(!this.submitOrder('standby')){this.standbyButton.set('disabled',false).removeClass('disabled');}}.bind(this));},selectVoucher:function(element){this.deselectVoucher(this.selectedElement);element.addClass('selected');if(element.hasClass('sold-out')){element.addClass('sold-out-selected');}
this.selectedElement=element;},deselectVoucher:function(element){if(element){element.removeClass('selected').removeClass('sold-out-selected');}},getSelectedElement:function(){return this.selectedElement;},getSelectedPrice:function(){return this.selectedElement.getElement('.price').get('text').toCurrencyValue();},getSelectedQuantity:function(){return(this.selectedElement.retrieve('dropdown')&&this.selectedElement.retrieve('dropdown').get('value'))?this.selectedElement.retrieve('dropdown').get('value'):1;},updateOrderForm:function(){this.resetOrderForm();if(this.selectedElement.hasClass('sold-out')){this.bookButton.hide();}else{this.bookButton.show();this.bookButton.set('disabled',false);}
var subtotalEl=this.attachTo.getElement('#subtotal .value');subtotalEl.removeClass('upd');var priceFx=new Fx.PriceTween(subtotalEl);var totalPrice=this.getSelectedPrice()*this.getSelectedQuantity();var discountedPrice=Jetsetter.promoDiscount?Jetsetter.promoDiscount.getDiscountedTotal():totalPrice;priceFx.start(discountedPrice).chain(function(){Jetsetter.promoDiscount&&Jetsetter.promoDiscount.fireEvent('update','subtotal');});},resetOrderForm:function(){this.orderForm.removeClass('hold').removeClass('standby');this.bookButton.set('disabled',true);},submitOrder:function(){if(Jetsetter.user.isAnonymous&&Jetsetter.user.isPriceHidden){Jetsetter.registrationModal.show();return false;}
var selectedVoucherElement=this.getSelectedElement();var selectedVoucherId=selectedVoucherElement.get('id').substr(8);var numOfVouchers=(this.getSelectedQuantity())?this.getSelectedQuantity():1;if(selectedVoucherElement.hasClass('sold-out')){}else{Jetsetter.secureLogin({onCloseEnd:function(){this.bookButton.set('disabled',false);}.bind(this),onLogin:function(){if(selectedVoucherElement.hasClass('expert')){location=Jetsetter.SECURE_HOST+'/checkout?voucher-id='+selectedVoucherId+'&quantity='+numOfVouchers+'&mode=expert';}else{location=Jetsetter.SECURE_HOST+'/checkout?voucher-id='+selectedVoucherId+'&quantity='+numOfVouchers+'&mode=voucher';}}});}
return false;}});var Ptp=new Class({Extends:Modal,initialize:function(attachTo,options){this.parent(Object.merge(options||{},{id:'ptp-modal',dismissable:false}));this.buildHtml();this.addEvent('showEnd',function(){$('close').addEvent('click',function(event){event.stop();this.close();}.bind(this));$('submit').addEvent('click',function(event){event.stop();var yourNameEl=$('your-name');var yourName=yourNameEl.get('value').trim();var emailAddressEl=$('email-address');var emailAddress=emailAddressEl.get('value').trim();var phoneNumberEl=$('phone-number');var phoneNumber=phoneNumberEl.get('value').trim();var numberOfTravelersEl=$('number-of-travelers');var numberOfTravelers=numberOfTravelersEl.get('value').trim();var dateRangeOfTravelEl=$('date-range-of-travel');var dateRangeOfTravel=dateRangeOfTravelEl.get('value').trim();var comments=$('comments').get('value').trim();var tccBoxEl=$('tcc-box');var bad=false;if(yourName.length==0){yourNameEl.addClass('error');bad=true;}else{yourNameEl.removeClass('error');}
if(emailAddress.length==0){emailAddressEl.addClass('error');bad=true;}else{emailAddressEl.removeClass('error');}
if(tccBoxEl.checked){tccBoxEl.getParent().getParent().removeClass('error');}else{tccBoxEl.getParent().getParent().addClass('error');bad=true;}
if(bad){return;}
var scope=this;var propertyService=new PropertyService();propertyService.addTripLeadGen({'propertyId':this.options.propertyId,'name':yourName,'email':emailAddress,'phone':phoneNumber,'numTravelers':numberOfTravelers,'dateRangeOfTravel':dateRangeOfTravel,'comments':comments,onSuccess:function(){scope.showSuccess();_gaq.push(['_trackEvent','LeadGen','ContactInfo','Submission']);},onFailure:function(){}});}.bind(this));}.bind(this));},showSuccess:function(){this.canvas.getElementById('ptpm2a').set('html','<span>Thank you</span>');this.canvas.getElementById('ptp-form').hide();this.canvas.getElementById('ptp-ty').show();},buildHtml:function(){var data={'propertyId':this.options.propertyId,'eventId':this.options.eventId},source='<div id="ptpm1">\
   <div id="ptpm2">\
    <div id="ptpm2a">\
     <span id="title">Start Your Journey</span>\
    </div>\
    <div id="close"></div>\
   </div>\
   <div id="ptp-form">\
    <div id="ptpm3">\
     <div id="ptpm3a">\
      <span>Your name</span>\
      <span>Email address</span>\
      <span>Phone number</span>\
      <span>Number of travelers</span>\
      <span>Date range of travel</span>\
      <span>Comments</span>\
     </div>\
     <div id="ptpm3b">\
      <input type="input" id="your-name" max="256" />\
      <input type="input" id="email-address" max="256" />\
      <input type="input" id="phone-number" max="25" />\
      <input type="input" id="number-of-travelers" max="3" />\
      <input type="input" id="date-range-of-travel" max="256" />\
      <textarea name="comments" id="comments" max="800"></textarea>\
      <div id="ptp-tcc"><div id="ptp-tcc-box"><input type="checkbox" id="tcc-box" value="" /></div> <div id="ptp-tcc-copy">By clicking Contact me, I agree to Jetsetter\'s Terms of Service and give my consent to contacted by Jetsetter\'s staff and/or third-party partners.</div></div>\
     </div>\
    </div>\
    <div id="ptpm4">\
     <div id="submit"><span>Contact Me</span></div>\
    </div>\
   </div>\
   <div id="ptp-ty" style="display:none">\
    <p>Thank you for your inquiry. You will be contacted from advice@jetsetter.com within 24 to 48 hours.</p>\
   </div>\
  </div>',template=Handlebars.compile(source);this.canvas.set('html',template(data));}});var VideoConsultModal=new Class({Extends:Modal,initialize:function(options){this.parent(Object.merge(options||{},{id:'video-consult-modal',dismissable:true}));this.buildHtml();},buildHtml:function(){var source='<a class="close-modal close-btn">&#215;</a>\
       <iframe src="http://jetsetter.herokuapp.com/new?url={{currentPage}}" height="630" width="600" scrolling="no"></iframe>',template=Handlebars.compile(source);this.canvas.set('html',template({currentPage:encodeURIComponent(window.location.href)}));}})
var ShareModal=new Class({Extends:Modal,initialize:function(options){this.setOptions(options);this.parent({'id':'share-modal','class':'tenor'});var propertyDetailsEl=new Element('div',{'class':'property clearfix'}).adopt(new Element('img',{'src':Jetsetter.CDN_HOST+'/static/'+this.options.propertyImage,'class':'fl','width':230,'height':125,'alt':''}),new Element('div',{'class':'fl'}).adopt(new Element('h2',{'text':this.options.propertyName}),new Element('h4',{'text':this.options.propertyLocation}),new Element('p',{'text':this.options.expirationTime||''})));this.canvas.adopt(new Element('div',{'class':'banner','html':'<h2>'+this.options.bannerTitle+'</h2>'}),propertyDetailsEl);propertyDetailsEl.setStyle('float','left');setTimeout(function(){var propertyDetailsElWidth=propertyDetailsEl.getSize().x;var formElWidth=770;propertyDetailsElWidth=(propertyDetailsElWidth>formElWidth)?formElWidth:propertyDetailsElWidth;propertyDetailsEl.setStyles({'float':'none','width':propertyDetailsElWidth+10});},0);var inviteEmailForm=new InviteEmailForm(this.canvas,{'message':this.options.message,'requestParams':{'type':'EmailInvite','propertyId':this.options.propertyId,'saleId':this.options.saleId||null}});inviteEmailForm.addEvent('emailFieldAdd',function(){omniture.trackFeature('ShareModal: adding new email field');_gaq.push(['_trackEvent','Modal','Share','AddNewEmail-Failed']);this.setPosition();}.bind(this));inviteEmailForm.addEvent('submitStart',function(){omniture.trackFeature('ShareModal: attempting to send');_gaq.push(['_trackEvent','Modal','Share','Attempt-Send']);})
inviteEmailForm.addEvent('invitesSent',function(numOfInvites){GA.trackInvites(numOfInvites,'share-modal');omniture.trackInvites(numOfInvites,'share-modal');omniture.trackFeature('ShareModal: send successful');_gaq.push(['_trackEvent','Modal','Share','Send-Success']);Jetsetter.NotificationCenter.success({message:"Your invites have been sent."});this.close();}.bind(this));omniture.trackFeature('ShareModal: opened');_gaq.push(['_trackEvent','Modal','Share','Opened']);}});var GalleryThumbs=new Class({Implements:[Events,Options],selectedThumbEl:null,initialize:function(rootEl,options){this.setOptions(options);this.slideShow=new SlideShow(rootEl.getElement('.thumbs'),{transition:'pushLeft',duration:350,onShow:function(data){}.bind(this)});this.rootEl=rootEl.addEvents({'click:relay(.thumbs li)':function(event,element){var index=element.get('data-index').toInt()
this.selectThumb(index);this.fireEvent('thumbClick',[index,this.selectedThumbEl]);}.bind(this),'click:relay(.nav)':function(event,element){if(element.hasClass('prev')){this.slideShow.show('previous',{transition:'pushRight'});}else{this.slideShow.show('next',{transition:'pushLeft'});}}.bind(this)});this.selectThumb(0);this.selectedThumbEl=this.rootEl.getElement('.selected');},selectSection:function(index,options){this.slideShow.show(index,options||{transition:(this.slideShow.index>index)?'pushRight':'pushLeft'});return this;},selectThumb:function(index){this.thumbsPerSection=this.thumbsPerSection||this.rootEl.getElement('.thumbs ul').getChildren().length;this.selectSection(Math.floor(index/this.thumbsPerSection));if(this.selectedThumbEl){this.selectedThumbEl.removeClass('selected');}
this.selectedThumbEl=this.rootEl.getElement('li[data-index='+index+']').addClass('selected');return this;}});var PdpGallery=new Class({Implements:Events,initialize:function(rootEl){this.fullView=rootEl.getElement('.full-view ul');this.navButtons=rootEl.getElements('.full-view .nav').set('tween',{transition:Fx.Transitions.Quint.easeOut});if(!this.fullView.getChildren().length){return this;}
this.galleryThumbs=new GalleryThumbs(rootEl.getElement('.thumbs-container'),{onThumbClick:function(index,element){this.selectScreenAtIndex(index);}.bind(this)});this.slideshow=new SlideShow(this.fullView,{duration:350,transition:'crossFade',onShow:function(data){this._loadImage(data.next.element);this._loadImage(this._getNextSlide());this.galleryThumbs.selectThumb(data.next.index)
this.fireEvent('show',data);}.bind(this)});this.rootEl=rootEl.addEvents({'mouseenter:relay(.full-view)':this.showNav.bind(this),'mouseleave:relay(.full-view)':this.hideNav.bind(this),'click:relay(.full-view .nav)':function(event,element){if(element.hasClass('prev')){this.prevImage();}else{this.nextImage();}}.bind(this),'click:relay(.thumbs li)':function(event,element){}.bind(this),'click:relay(.cta-360)':function(e,elem){this._loadPano(elem);}.bind(this)});this.keyboardNavHandler=function(event){switch(event.key){case'left':this.prevImage();break;case'right':this.nextImage();break;}}.bind(this)
if(this.slideshow.current.get('data-mediatype')==='pano'){this._loadImage(this.slideshow.current);}},showNav:function(){this.navButtons.each(function(el){el.fade('in');});$(window).addEvent('keydown',this.keyboardNavHandler);},hideNav:function(){this.navButtons.each(function(el){el.fade('out');});$(window).removeEvent('keydown',this.keyboardNavHandler);},selectScreenAtIndex:function(index,options){if(this.slideshow.transitioning){return;}
this.slideshow.show(index,options);},showImageById:function(id){var slide=this.fullView.getElement('[data-id='+id+']'),index=this.slideshow.slides.indexOf(slide);this.selectScreenAtIndex(index,{transition:'none'});},prevImage:function(){var index=this.slideshow.slides[this.slideshow.index-1]?this.slideshow.index-1:this.slideshow.slides.length-1;this.selectScreenAtIndex(index);},nextImage:function(){var index=this.slideshow.slides[this.slideshow.index+1]?this.slideshow.index+1:0;this.selectScreenAtIndex(index);},_getNextSlide:function(){var currentIndex=this.slideshow.index;return this.slideshow.slides[(currentIndex+1)%this.slideshow.slides.length];},_loadImage:function(element){if(!element.getElement('img')&&element.get('data-mediatype')==='img'&&!element.getElement('object')){var imgEl=new Element('img',{'src':element.get('data-src'),width:690,height:390,'alt':element.get('data-alt')}).inject(element,'top');element.removeProperty('data-src');}
return this;},_loadPano:function(elem){elem.getSiblings('img')[0].destroy();var textures=elem.get('data-pano1')+','+elem.get('data-pano2'),swf=new Swiff(Jetsetter.CDN_HOST+'/static/images/pano/WebPano.swf?v=2',{width:690,height:390,params:{bgcolor:'#000000',allowFullscreen:true,wmode:'opaque',wMode:'opaque'},vars:{maxFOVUp:20,maxFOVDown:20,textures:textures,startInertia:-15}});swf.inject(elem.getParent(),'top');elem.destroy();}});var GalleryModal=new Class({Extends:Modal,options:{title:'',byline:'',images:[]},initialize:function(options){this.parent({id:'gallery-modal',overlayOpacity:1,dismissable:false,minWidth:1220});this.setOptions(options);this.addCloseButton();var imagesEl=new Element('ul',{'class':'images'});var dotsContainerEl=new Element('div');var previousEl=new Element('div',{'class':'nav previous unselectable tenor','html':'<a><span class="icon"></span> Previous</a>'});var nextEl=new Element('div',{'class':'nav next unselectable tenor','html':'<a>Next <span class="icon"></span></a>'});this.options.images.each(function(image,index){if(image.type==='img'){var listItemEl=new Element('li',{'data-id':image.id,'data-src':image.url,'data-mediatype':'img','data-alt':image.title+': '+image.caption}).adopt([new Element('div',{'class':'caption tenor','html':'<p>'+image.caption+'</p>'})]);}
else if(image.type==='pano'&&Browser.Plugins.Flash&&Browser.Plugins.Flash.version>=9){var listItemEl=new Element('li',{'data-id':image.id,'data-mediatype':'pano'}).adopt([new Element('div',{'class':'pano-wrap','data-pano1':image.pano1,'data-pano2':image.pano2}),new Element('div',{'class':'caption tenor','html':'<p>'+image.caption+'</p>'})]);}
else if(image.type==='pano'&&(!Browser.Plugins.Flash||Browser.Plugins.Flash.version<9)){var listItemEl=new Element('li',{'data-id':image.id,'data-src':image.thumb,'data-mediatype':'img'}).adopt([new Element('div',{'class':'caption tenor','html':'<p>'+image.caption+' (Flash Required)</p>'})]);}
imagesEl.adopt(listItemEl);});var galleryDots=new GalleryDots(dotsContainerEl,{numOfDots:this.options.images.length,onChange:function(index){this.slideShow.show(index);}.bind(this)});this.slideShow=new SlideShow(imagesEl,{onShow:function(data){this._loadImage(data.next.element);this._loadImage(this._getNextSlide());galleryDots.select(data.next.index);this.fireEvent('change',[data.next.index,this._getCurrentImageId()]);}.bind(this)});if(this.options.showPinIt){this.slideShow.addEvents({onShow:function(data){this._hidePinItButton(data.next.index);}.bind(this),onShowComplete:function(data){this._showPinItButton(data.next.index);}.bind(this)});}
this.rootEl=this.content.adopt([new Element('div',{'class':'gallery'}).adopt([imagesEl,previousEl,nextEl,dotsContainerEl]),new Element('div',{'class':'meta'}).adopt([new Element('h1',{'class':'title tenor','text':this.options.title}),new Element('p',{'class':'byline','text':this.options.byline})])]).addEvents({'click:relay(.previous)':function(){this.slideShow.show('previous');}.bind(this),'click:relay(.next)':function(){this.slideShow.show('next');}.bind(this),'mouseover:relay(.gallery)':function(event,element){this._fadeIn(dotsContainerEl);this._fadeIn(previousEl);this._fadeIn(nextEl);}.bind(this),'mouseout:relay(.gallery)':function(event,element){this._fadeOut(dotsContainerEl);this._fadeOut(previousEl);this._fadeOut(nextEl);}.bind(this)});this.rootEl.getElements('.nav').each(function(element){element.get('tween').set('opacity',0);element.setStyle('visibility','visible');});dotsContainerEl.setStyle('visibility','visible').get('tween').set('opacity',0);this._onKeyUp=function(event){switch(event.key){case'left':this.slideShow.show('previous');break;case'right':this.slideShow.show('next');break;}}.bind(this);this.rootEl.addEvent('keyup:relay(object)',function(e){e.stop();});},_fadeIn:function(element){element.set('tween',{duration:300,transition:Fx.Transitions.Quint.easeOut}).tween('opacity',1);return this;},_fadeOut:function(element){element.set('tween',{duration:300,transition:Fx.Transitions.Quint.easeOut}).tween('opacity',0).get('tween').chain(function(){element.setStyle('visibility','visible')});return this;},_loadImage:function(element){var dataSrc=element.get('data-src');if(dataSrc&&element.get('data-mediatype')==='img'){var imgEl=new Element('img',{'width':1200,'height':600,'src':dataSrc,'alt':element.get('data-alt')}).inject(element,'top');element.removeProperty('data-src');}
else if(element.get('data-mediatype')==='pano'&&!element.getElement('object')){var panoDiv=element.getElement('.pano-wrap'),textures=panoDiv.get('data-pano1')+','+panoDiv.get('data-pano2'),swf=new Swiff(Jetsetter.CDN_HOST+'/static/images/pano/WebPano.swf?v=2',{width:1200,height:600,params:{bgcolor:'#000000',allowFullscreen:true,wmode:'opaque',wMode:'opaque'},vars:{maxFOVUp:20,maxFOVDown:20,textures:textures,fullscreenButton:true,startInertia:-15}});swf.inject(panoDiv);}
return this;},_showPinItButton:function(index){var url=this.options.images[index].publicUrl+'osocid=pinterest';var image=this.options.images[index].pin;var description=encodeURIComponent(this.options.images[index].safeCaption);var pinItEl=new Element('div',{'class':'pin-it'}).inject(this.slideShow.current);var pinItLink=new Element('a',{'class':'pin-it-button','count-layout':'horizontal','html':'Pin It','href':'http://pinterest.com/pin/create/button/?url='+url+'&media='+image+'&description='+description}).inject(pinItEl);var pinItScript=new Element('script',{'type':'text/javascript','src':'http://assets.pinterest.com/js/pinit.js'}).inject(pinItEl);return this;},_hidePinItButton:function(index){var pinItEl=this.slideShow.slides[index].getElement('.pin-it');if(pinItEl){pinItEl.get('tween').set('opacity',0);}
return this;},_getNextSlide:function(){var currentIndex=this.slideShow.index;return this.slideShow.slides[(currentIndex+1)%this.slideShow.slides.length];},_getCurrentImageId:function(){return this.slideShow.current.get('data-id').toInt();},toElement:function(){return this.rootEl;},show:function(index){this.parent();if(this.slideShow.index===index){this._loadImage(this.slideShow.current);}else{this.slideShow.show(index,{transition:'none'});}
this._loadImage(this._getNextSlide());if(this.options.showPinIt){this._showPinItButton(index);}
document.addEvent('keyup',this._onKeyUp);return this;},close:function(){this.parent();this.fireEvent('close',this._getCurrentImageId());document.removeEvent('keyup',this._onKeyUp);}});var GoogleMaps=new Class({Implements:Options,options:{latitude:'40.727019100124934',longitude:'-74.038931884375',zoomLevel:12,marker:{title:'',latitude:'40.727019100124934',longitude:'-74.038931884375',imageUrl:Jetsetter.CDN_HOST+'/static/images/layout/map_marker.png'}},map:null,initialize:function(rootEl,options){this.rootEl=rootEl;this.setOptions(options);this.rootEl.addEvent('mousedown',function(event){event.stop();this.enableScroll();}.bind(this));if(window.google&&google.maps){this.loadMap();}else{GoogleMaps.loadMap=this.loadMap.bind(this);var scriptEl=document.createElement('script');scriptEl.async=true;scriptEl.src='http://maps.google.com/maps/api/js?sensor=false&callback=GoogleMaps.loadMap'+'&client='+Jetsetter.mapKey;document.body.appendChild(scriptEl);}},loadMap:function(){var latlng=new google.maps.LatLng(this.options.latitude,this.options.longitude);this.map=new google.maps.Map(this.rootEl,{zoom:this.options.zoomLevel,center:latlng,mapTypeId:google.maps.MapTypeId.TERRAIN,scrollwheel:false});var markerImage=new google.maps.MarkerImage(this.options.marker.imageUrl);var markerLatLng=new google.maps.LatLng(this.options.marker.latitude,this.options.marker.longitude);var marker=new google.maps.Marker({position:markerLatLng,map:this.map,title:this.options.marker.title});marker.setIcon(markerImage);},enableScroll:function(){this.map.setOptions({scrollwheel:true});document.addEvent('mousedown:once',this.disableScroll.bind(this));window.addEvent('scroll:once',this.disableScroll.bind(this));return this;},disableScroll:function(){this.map.setOptions({scrollwheel:false});return this;}});var Comments=new Class({Implements:Options,initialize:function(attachTo,options){this.setOptions(options);var scope=this;this.wrapper=attachTo;this.list=attachTo.getElement('ul');this.moreLink=attachTo.getElement('#more-comments');this.moreLink&&this.moreLink.getElement('a').addEvent('click',function(){scope.get();return false;});this.comments=[];this.list.getElements('li').each(function(comment,i){if(!comment.hasClass('reply')){scope.comments.push(comment);}});this.start=null;this.limit=10;this.postCommentFormEl=$('post-comment').addEvent('submit',function(event){event.preventDefault();if(Jetsetter.user.isAnonymous){Jetsetter.registrationModal.show();}else{scope.submit();}});this.postCommentButtonEl=this.postCommentFormEl.getElement('button[type=submit]').set('disabled',false);attachTo.getElement('textarea').addEvent('keypress',function(event){switch(event.key){case'backspace':case'delete':return true;}
return this.get('value').length<this.get('_maxlength');}).addEvent('change',function(event){this.set('value',this.get('value').substring(0,this.get('_maxlength')));});},get:function(){var scope=this;new CommentService().getCommentsByPropertyId({propertyId:this.options.propertyId,eventId:this.options.eventId,offset:this.comments.length,limit:this.limit,onSuccess:function(data){if(Jetsetter.totalNumOfComments<=scope.comments.length+scope.limit){scope.moreLink.hide();if(Jetsetter.totalNumOfComments==0&&scope.comments.length==0){var postCommentEl=scope.wrapper.getElement('a.post-comment');postCommentEl&&postCommentEl.hide();return;}}else{scope.moreLink.show();}
scope.buildComments(data);},onFailure:function(){}})},buildComments:function(comments,isReply){for(var i=0;i<comments.length;i++){var comment=comments[i];var reply=isReply;var fbid=comment.authorFacebookId?comment.authorFacebookId:null;var commentEl=new Element('li',{'class':'comment'});if(reply){commentEl.addClass('reply');}
var imageUrl=(fbid)?'https://graph.facebook.com/'+fbid+'/picture':Jetsetter.CDN_HOST+'/static/images/layout/quote-square.png';new Element('img',{'width':50,'height':50,'src':imageUrl}).inject(commentEl);var paragraphs=comment.text.split('\n');new Element('blockquote',{'html':'<p>'+paragraphs.join('</p><p>')+'</p>'}).inject(commentEl);new Element('cite',{'html':'<span class="name">'+(comment.authorName==null?'Anonymous User':comment.authorName)+'</span> '}).adopt(new Element('span',{'class':'time','title':new Date(comment.submitted*1000).format('long'),'html':moment.unix(comment.submitted).fromNow()})).inject(commentEl);if(reply){new Element('div',{'class':'reply-indicator'}).inject(commentEl);}
if(!reply){this.comments.push(commentEl);}
commentEl.inject(this.list);if(comment.replies){this.buildComments(comment.replies,true);}}},submit:function(){if(this.postCommentFormEl.getElement('textarea[name="text"]').get('value').length<3){return false;}
Jetsetter.secureLogin({onLogin:function(){this.postCommentButtonEl.set('disabled',true);new CommentService().addComment({eventId:this.options.eventId,propertyId:this.options.propertyId,text:this.postCommentFormEl.toQueryObject().text,onSuccess:function(data){var wrapper=new Element('div',{'id':'comment-submitted','class':'shaded'});new Element('h3',{html:'Your comment has been submitted!'}).inject(wrapper);new Element('p',{html:'We&rsquo;ll review your submission before publishing it, so it won&rsquo;t be visible right away.'}).inject(wrapper);$$('a[href$="post-comment"]').hide();wrapper.replaces($('post-comment'));},onFailure:function(err){new NotificationModal('An internal error has occured','error').show();}})}.bind(this),'access':'insecure','dismissOnLogin':true})}});var Reviews=new Class({Implements:Options,options:{ignoreEventSpecific:false},initialize:function(attachTo,options){this.setOptions(options);var scope=this;this.wrapper=attachTo;this.list=attachTo.getElement('ul');this.moreLink=attachTo.getElement('#more-reviews');this.moreLink&&this.moreLink.getElement('a').addEvent('click',function(){scope.get();return false;});this.wrapper.addEvent('click:relay(.was-helpful a)',function(event,element){event.preventDefault();var reviewId=element.get('data-id');new Element('span',{'html':'Thank you for your feedback.'}).replaces(element).highlight('#ddd');new ReviewService().reviewWasHelpful({reviewId:reviewId,onSuccess:function(){},onFailure:function(){}})});this.reviews=[];this.list.getElements('li').each(function(review,i){scope.reviews.push(review);});this.start=null;this.limit=10;},get:function(){var scope=this;new ReviewService().getReviewsByPropertyId({eventId:this.options.eventId,propertyId:this.options.propertyId,offset:this.reviews.length,limit:this.limit,ignoreEventSpecific:this.options.ignoreEventSpecific,onSuccess:function(data){if(Jetsetter.totalNumOfReviews<=scope.reviews.length+scope.limit){scope.moreLink.hide();}else{scope.moreLink.show();}
scope.buildReviews(data);},onFailure:function(){}});},buildReviews:function(reviews){for(var i=0;i<reviews.length;i++){var review=reviews[i];var fbid=review.authorFacebookId?review.authorFacebookId:null;var reviewEl=new Element('li',{'class':'review'});var imageUrl=(fbid)?'https://graph.facebook.com/'+fbid+'/picture':Jetsetter.CDN_HOST+'/static/images/layout/quote-square.png';new Element('img',{'width':50,'height':50,'alt':'','src':imageUrl}).inject(reviewEl);var blockquote=new Element('blockquote',{'html':'<div class="notch"></div>'});if(review.whatILoved){var whatILovedParagraphs=review.whatILoved.split('\n');new Element('div',{'class':'review-section','html':'<h3>What I liked</h3>'+'<p>'+whatILovedParagraphs.join('</p><p>')+'</p>'}).inject(blockquote);}
if(review.whatToKnow){var whatToKnowParagraphs=review.whatToKnow.split('\n');new Element('div',{'class':'review-section last','html':'<h3>What I disliked</h3>'+'<p>'+whatToKnowParagraphs.join('</p><p>')+'</p>'}).inject(blockquote);}
new Element('div',{'class':'review-content'}).adopt(blockquote,new Element('cite',{'html':'<span class="name">'+(!review.authorName?'Anonymous User':review.authorName)+'</span> '}).adopt(new Element('span',{'class':'time','title':new Date(review.submitted*1000).format('long'),'html':moment.unix(review.submitted).fromNow()}))).inject(reviewEl);new Element('div',{'class':'was-helpful'}).adopt(new Element('a',{'class':'action','html':'This was helpful','data-id':review.reviewId})).inject(reviewEl);this.reviews.push(reviewEl);reviewEl.inject(this.list);}},reviewWasHelpful:function(review){alert(review.reviewCreatedDisplay);}});var AddFavorite=new Class({Implements:[Options,Events],options:{reload:false},initialize:function(rootEl,options){this.setOptions(options);this.rootEl=rootEl;this.property=this.rootEl.get('data-property');this.showTooltip=true;this.textEl=this.rootEl.getElement('.text')||this.rootEl;this._toDefaultState();if(Cookie.read('j_cli')&&JSON.decode(Base64.decode(Cookie.read('j_cli')))){var customListIds=JSON.decode(Base64.decode(Cookie.read('j_cli')));if(customListIds&&customListIds.propertyId&&customListIds.propertyId.indexOf(parseInt(this.property))!=-1){this._toAddedState();}}
var self=this;self.rootEl.addEvent('click',function(){self.toggleFav();});},_toDefaultState:function(){this.rootEl.removeClass('add-to-favs-added');this.textEl.set('html','<span class="icon icon-favs"></span>'+Locale.get('Copy.pdp-add-to-favorites'));return this;},_toAddedState:function(){this.rootEl.addClass('add-to-favs-added');this.textEl.set('html','<span class="icon icon-favs"></span>'+Locale.get('Copy.pdp-favorite'));return this;},addFav:function(){Jetsetter.secureLogin({dismissOnLogin:true,onCloseEnd:function(){},onLogin:function(){var req=new Request.JSON({retries:1,url:'/customlist/saveitem',data:{'property-id':this.property,'sessionId':Jetsetter.user.session.st},onSuccess:function(json){if(json.success){json.data.show=this.getCount();Cookie.write('j_cli',Base64.encode(JSON.encode(json.data)),{domain:Jetsetter.cookieDomain,path:'/',duration:365});this._toAddedState();if(this.options.reload){window.location.reload();}else{Jetsetter.NotificationCenter.success({message:'Property added to favorites.'});}}else{Jetsetter.NotificationCenter.error({message:'Uh oh, something went wrong.',cta:'Try Again?',onCtaClick:function(){this.addFav();}.bind(this)});}}.bind(this),onFailure:function(){}}).get();omniture.trackFeature('add-favorites-add');_gaq.push(['_trackEvent','Favorites','Add','Click']);}.bind(this)});},removeFav:function(){var req=new Request.JSON({retries:1,url:'/customlist/deleteitem',data:{'property-id':this.property},onSuccess:function(json){if(json.success){if(json.data.length===0){json.data={};json.data.propertyIds=[];}
json.data.show=this.getCount();Cookie.write('j_cli',Base64.encode(JSON.encode(json.data)),{domain:Jetsetter.cookieDomain,path:'/',duration:365});this._toDefaultState();if(this.options.reload){window.location.reload();}else{Jetsetter.NotificationCenter.success({message:'Property removed from favorites.'});}}else{Jetsetter.NotificationCenter.error({message:'Uh oh, something went wrong.',cta:'Try Again?',onCtaClick:function(){this.removeFav();}.bind(this)});}}.bind(this)}).get();omniture.trackFeature('add-favorites-remove');_gaq.push(['_trackEvent','Favorites','Remove','Click']);},getCount:function(){if(Cookie.read('j_cli')&&typeof(JSON.decode(Base64.decode(Cookie.read('j_cli')))||{}).show!=='undefined'){return JSON.decode(Base64.decode(Cookie.read('j_cli'))).show;}
else{return 0;}},toggleFav:function(){var self=this;switch(self.rootEl.hasClass('add-to-favs-added')){case true:self.removeFav();break;case false:self.addFav();break;}}});var FavsTooltip=new Class({Implements:Events,initialize:function(rootEl){this.rootEl=rootEl;var self=this,close=self.rootEl.getElement('.hide');if(Cookie.read('j_cli')){this.cookie=JSON.decode(Base64.decode(Cookie.read('j_cli')));}
else{this.cookie={};this.createCookie();}
rootEl.position({relativeTo:$('secondary-nav'),position:{x:'left',y:'bottom'},offset:{x:-90}});close.addEvent('click',function(e){e.stop();self.hide();});},show:function(){if(JSON.decode(Base64.decode(Cookie.read('j_cli'))).show<4){this.cookie=JSON.decode(Base64.decode(Cookie.read('j_cli')));this.rootEl.setStyle('display','block');new Fx.Tween(this.rootEl).start('opacity',0,1);this.cookie.show=parseInt(this.cookie.show)+1;Cookie.write('j_cli',Base64.encode(JSON.encode(this.cookie)),{domain:Jetsetter.cookieDomain,path:'/',duration:365});}},neverShow:function(){this.cookie=JSON.decode(Base64.decode(Cookie.read('j_cli')));this.cookie.show=4;Cookie.write('j_cli',Base64.encode(JSON.encode(this.cookie)),{domain:Jetsetter.cookieDomain,path:'/',duration:365});},createCookie:function(){this.cookie.show=0;Cookie.write('j_cli',Base64.encode(JSON.encode(this.cookie)),{domain:Jetsetter.cookieDomain,path:'/',duration:365});},hide:function(){if(this.rootEl.getStyle('display')==='block'){var closeEffect=new Fx.Tween(this.rootEl).start('opacity',1,0).chain(function(){this.rootEl.setStyle('display','none');}.bind(this));}
if(!arguments[0]){this.neverShow();}}});var SplashInvite=new Class({Extends:BaseForm,Implements:Social.InviteEmail,initialize:function(rootEl){this.rootEl=rootEl;this.inviteViewEl=this.rootEl.getElement('.invite-view');this.sentViewEl=this.rootEl.getElement('.sent-view');this.formEl=this.rootEl.getElement('form');this.submitButtonEl=this.formEl.getElement('.submit');this.errorMessageEl=new Element('p',{'class':'error'}).inject(this.formEl,'top');this.addMoreButtonEl=this.formEl.getElement('.add-more');var emailContainerEl=this.formEl.getElement('.email-fields');this.getNewEmailEl().replaces(emailContainerEl.getFirst('.email'));this.addMoreButtonEl.addEvent('click',function(){var numOfEmailFields=emailContainerEl.getChildren().length;if(numOfEmailFields<5){this.getNewEmailEl().inject(emailContainerEl).hide().reveal({'duration':'short'});this.fireEvent('emailFieldAdd');if(numOfEmailFields==4){this.addMoreButtonEl.hide();}}}.bind(this));this.addEvent('formDisable',function(){this.submitButtonEl.set('text','Sending Invites…');this.submitButtonEl.getParent().addClass('sending');});this.addEvent('formEnable',function(){this.submitButtonEl.set('text','Send Invitations');this.submitButtonEl.getParent().removeClass('sending');});this.sentViewEl.getElement('button').addEvent('click',function(){this.resetSentView();this.showInviteView();}.bind(this));this.bindSubmitFunction();},submitForm:function(){omniture.trackFeature('splash-invite: sending invite');_gaq.push(['_trackEvent','Invite','SplashInvite','Send']);var emailFieldEls=this.getValidEmailFields();if(!emailFieldEls){return false;}
new InviteService().sendInvitations({validatedEmailAddresses:emailFieldEls.get('value'),method:'splash',guid:Jetsetter.user.guid,customMessage:0,onSuccess:function(json){GA.trackInvites(emailFieldEls.length,'splash');omniture.trackInvites(emailFieldEls.length,'splash');_gaq.push(['_trackEvent','Invite','SplashInvite','Send-Sucess']);this.showSentView();Jetsetter.NotificationCenter.success({message:"Your invites have been sent."});}.bind(this),onFailure:function(){omniture.trackFeature('splash-invite: send attempt failed');_gaq.push(['_trackEvent','Invite','SplashInvite','Send-Failed']);this.enableForm();Jetsetter.NotificationCenter.error({message:'Uh oh, something went wrong.',cta:'Try Again?',onCtaClick:function(){this.submitForm();}.bind(this)});}.bind(this)});},showInviteView:function(){this.sentViewEl.fade('out').hide();this.inviteViewEl.show().fade('in');},showSentView:function(){this.inviteViewEl.fade('out').hide();this.sentViewEl.show().fade('in');},resetSentView:function(){this.formEl.getElement('.email-fields').empty().adopt(this.getNewEmailEl());this.enableForm();this.addMoreButtonEl.show();}});(function(){var newCalendarInit=function(property){var queryParams=new URI().get('data');var options={checkInDate:queryParams.checkin&&queryParams.checkin.toDateObject(),checkOutDate:queryParams.checkout&&queryParams.checkout.toDateObject(),numOfRooms:queryParams.numRooms?queryParams.numRooms.toInt():1,numOfGuests:queryParams.numAdults?queryParams.numAdults.toInt():null};if(queryParams.month){var monthSplit=queryParams.month.split('/',2);if(monthSplit.length>1){var monthPart=monthSplit[0];var yearPart=monthSplit[1];options.selectedMonth=new Date(yearPart,monthPart-1,1);}}
if(typeOf(Jetsetter.products)==='object'){var tripBuilder=new TripBuilder2($('trip-builder-2'),property,Jetsetter.eventId,options);tripBuilder.addEvent('productChange',function(productId){$('details').getElements('.hideable-detail').hide();$('details').getElements('.product-'+productId).show();});var abTest=new ABTest();if(abTest.executeForVariation('hide_lowest_price')){$('product-pricing').addClass('hide-price');}
var youSaveEl=$('you-save'),discountPercentageEl=$('jetsetter-discount'),userDicountParentEl=$('user-discount'),priceTweenFx=new Fx.PriceTween(youSaveEl,{numberFormat:{decimals:0}}),percentTweenFx=new Fx.PriceTween(discountPercentageEl,{numberFormat:{decimals:0,suffix:'%',prefix:''}});function hideUserDiscount(){new Fx.Tween(userDicountParentEl,{property:'height'}).start(0);userDicountParentEl.fade();}
hideUserDiscount();tripBuilder.addEvent('orderUndo',hideUserDiscount);tripBuilder.addEvent('updateSubtotal',function(marketSubtotal,jetsetterSubtotal){var discountPercentage=((marketSubtotal-jetsetterSubtotal)/marketSubtotal)*100,youSave=marketSubtotal-jetsetterSubtotal;if(discountPercentage>0||youSave>0){userDicountParentEl.addClass('showing');userDicountParentEl.show();new Fx.Tween(userDicountParentEl,{property:'height'}).start(80).chain(function(){userDicountParentEl.fade('in');priceTweenFx.start(youSave);percentTweenFx.start(discountPercentage);})}});}}
var oldCalendarInit=function(property){if(property.mode!='archive'){var productSelectorEl=$('product-selector');var selectedProductEl=productSelectorEl.getElement('.selected-product');var productListEl=productSelectorEl.getElement('ul');var productEls=productListEl.getElements('li');var calendarOverlayEl=$('calendar-overlay');var loadingMessageEl=calendarOverlayEl.getElement('.loading');var tripBuilderEl=$('trip-builder');var tripBuilder=new TripBuilder(tripBuilderEl,property.productId,Jetsetter.eventId);if(Jetsetter.user.isAnonymous&&Jetsetter.user.isPriceHidden){var pricingEl=$('product-pricing');pricingEl.getElement('.our-price').hide();pricingEl.getElement('.compare').hide();}else{$$('.product-price').each(function(el){el.show();});}}
function showCalendarOverlay(){if(Browser.ie6||Browser.ie7){calendarOverlayEl.setStyle('height',$('product-booking').getStyle('height'));}
calendarOverlayEl.show();}
function onCalendarReady(){if(tripBuilder.numRooms!=undefined&&tripBuilder.numRooms!=tripBuilder.quantity.getSelectedItem().value){tripBuilder.quantity.selectItem(tripBuilder.numRooms-1);}
calendarOverlayEl.hide();loadingMessageEl.hide();}
function updateTripBuilder(productId,saleId){if(tripBuilder.itemID!=productId||tripBuilder.saleID!=saleId){omniture.trackFeature('change-product');_gaq.push(['_trackEvent','PDP','ChangeProduct','Selected']);var numRooms=tripBuilder.quantity.getSelectedItem().value;if(tripBuilder.packagesReq!=null){tripBuilder.packagesReq.cancel();}
tripBuilderEl.setStyle('height',tripBuilderEl.getSize().y).empty();showCalendarOverlay()
loadingMessageEl.show();tripBuilder=new TripBuilder(tripBuilderEl,productId,saleId,numRooms);tripBuilder.events.addEvent('packagesupdated',function(){tripBuilderEl.setStyle('height','auto');onCalendarReady();});}else{onCalendarReady();}
if(tripBuilder.numRooms==numRooms){onCalendarReady();}}
function selectProduct(el){var id=el.getElement('input[name=room-type]').get('value');var name=el.getElement('.product-name').get('text');selectedProductEl.empty().adopt(new Element('h4',{'text':name}));updateTripBuilder(id,Jetsetter.eventId);$('details').getElements('.hideable-detail').hide();$('details').getElements('.product-'+id).show();}
if(property.mode!='archive'){var productsSlideFx=new Fx.Slide(productListEl,{'duration':'short'});productEls.addEvents({mouseenter:function(){this.addClass('selected');},mouseleave:function(){this.removeClass('selected');}});productListEl.getElements('input').addEvent('click',function(event){if(Jetsetter.user.isAnonymous&&Jetsetter.user.isPriceHidden){Jetsetter.registrationModal.show();}else{productSelectorEl.getElement('.tip').hide();productsSlideFx.slideOut().chain(function(){selectProduct($(event.target).getParent('li'));productListEl.hide();});}});selectedProductEl.addEvent('click',function(){this.empty().adopt(new Element('p',{'class':'select-room','text':'Select a '+(Jetsetter.property.propertyTypeId==4?'flight':'room')}));showCalendarOverlay()
productListEl.show();productsSlideFx.slideIn();return false;});function initProductSelector(){tripBuilder.events.removeEvent('packagesupdated',initProductSelector);if(true||defaultSaleProductItemIndex==-1){var productSelectorTipEl=productSelectorEl.getElement('.tip');if(Jetsetter.user.isAnonymous&&Jetsetter.user.isPriceHidden){selectedProductEl.fireEvent('click');productSelectorTipEl.show();}else{if(productEls.length==1){productEls[0].getElement('input').click();}else{selectedProductEl.fireEvent('click');productSelectorTipEl.show();}}}else{productEls[defaultSaleProductItemIndex].getElement('input').click();}}
tripBuilder.events.addEvent('packagesupdated',initProductSelector);}}
Jetsetter.packages.product.init=function(){if(Jetsetter.user.isAnonymous&&Jetsetter.user.isPriceHidden){Jetsetter.anonymousBrowse.showRegistrationModal();}
var property=Jetsetter.property;var infoEl=$('info');var mainRailEl=$('com-left');var tabContainerEl=mainRailEl.getElement('ul.info-tabs');var commentsEl=$('all-comments');var j_pid=JSON.decode(Cookie.read('j_pid'))||[];j_pid.unshift(Jetsetter.property.propertyId);j_pid=j_pid.unique().slice(0,6);Cookie.write('j_pid',JSON.encode(j_pid),{duration:7,domain:Jetsetter.cookieDomain});var mapsTabMap=null;function showBreadcrumbs(){if(Jetsetter.user&&Jetsetter.user.partition){if((Jetsetter.user.partition>=201)&&(Jetsetter.user.partition<=400)){$$('.breadcrumbs.full').show();}else if((Jetsetter.user.partition>=401)&&(Jetsetter.user.partition<=600)){$$('.breadcrumbs.simple').show();}}}
function switchTab(tabEl){tabContainerEl.getElement('.selected').removeClass('selected');tabEl.getParent('li').addClass('selected');var selectedSectionId=tabEl.get('href').substr(1);infoEl.getElements('.section').removeClass('selected-section');$(selectedSectionId).addClass('selected-section');var hash=new URI(tabEl.get('href')).get('fragment');switch(hash){case'reviews':break;case'area':case'maps-and-attractions':if(!mapsTabMap){var mapEl=$(selectedSectionId).getElement('.google-map');if(mapEl){mapsTabMap=new GoogleMaps(mapEl,Jetsetter.property.map);}}
break;case'all-comments':default:}}
function getPropertyKey(){return(Jetsetter.eventAlias?Jetsetter.eventAlias+'/':'')+Jetsetter.property.alias;}
function getPropertyInviteUrl(){var key='';switch(property.mode){case'flash':key='p';break;case'retail':key='r';break;case'archive':key='c';break;}
return Jetsetter.user.getInviteUrl()+'?'+key+'='+getPropertyKey();}
window.addEvent('fbReady',function(){var fbLikeEl=$('facebook-like');if(fbLikeEl){FB.XFBML.parse(fbLikeEl);}
FB.Event.subscribe('edge.create',function(response){var responseUri=new URI(response);if(responseUri.get('directory').indexOf('/image/')===0){Jetsetter.tracker.trackEvent({'eventType':'feature','key34':'fullScreenFbLike','key37':Jetsetter.property.propertyId,'key38':responseUri.get('file')})}else if(responseUri.get('file')===property.alias){Jetsetter.tracker.trackEvent({'eventType':'feature','key34':'propertyLike'});}});});var galleryEl=$('screen-gallery');if(galleryEl){var pdpGal=new PdpGallery(galleryEl);galleryEl.addEvent('click:relay(.enlarge)',function(event,element){event.preventDefault();omniture.trackFeature('pdp-open-fullscreen-gallery-button');_gaq.push(['_trackEvent','PDP','FulScreenGalleryButton','Clicked']);launchFullscreen(element);});galleryEl.addEvent('click:relay(.full-area)',function(event,element){event.preventDefault();if(element.getSiblings('.enlarge')[0]){omniture.trackFeature('pdp-open-fullscreen-gallery-image');_gaq.push(['_trackEvent','PDP','FulScreenGalleryImage','Clicked']);launchFullscreen(element.getSiblings('.enlarge')[0]);}});function launchFullscreen(element){var index=element.get('data-index').toInt(),images=[];property.gallery.each(function(image){if(image.large&&image.type==='img'){images.push({id:image.mediaId,pageUrl:image.pageUrl,publicUrl:image.publicUrl,url:image.large,pin:image.pin,caption:image.caption,safeCaption:image.safeCaption,title:property.propertyName,type:'img'});}
if(image.type==='pano'){images.push({id:image.mediaId,pageUrl:image.pageUrl,publicUrl:image.publicUrl,caption:image.caption,pano1:image.pano1,pano2:image.pano2,thumb:image.thumb,url:image.thumb,safeCaption:image.safeCaption,type:'pano'})}});new GalleryModal({title:property.propertyName,byline:property.propertyLocation,images:images,onClose:function(){pdpGal.selectScreenAtIndex(this.slideShow.index,{transition:'none'});},onChange:function(index,imageId){Jetsetter.tracker.trackEvent({'eventType':'feature','key34':'fullScreenInteraction','key38':imageId,'key39':(index+1)});},showPinIt:true}).show(index);Jetsetter.tracker.trackEvent({'eventType':'feature','key34':'fullScreenView','key38':element.getParent('li').get('data-id').toInt(),'key39':(index+1)});}
pdpGal.addEvent('show',function(data){var prev=$('pin'+data.previous.index);if(prev){prev.hide();}
var next=$('pin'+data.next.index);if(next){next.show();}}.bind(this));}
if(property.mode=='archive'){var saleReminderButton=$('com-right').getElement('.sale-reminder');saleReminderButton.addEvent('click',function(){saleReminderButton.set('disabled',true);var req=new Request.JSON({url:'/saleasync.php',data:{'action':'createAlert','woeId':property.propertyWoeId},onSuccess:function(json){if(json.success){var fadeFx=new Fx.Tween(saleReminderButton).start('opacity',0).chain(function(){saleReminderButton.set('disabled',false);saleReminderButton.set('html','<span>Manage my alerts</span>').fade('in');saleReminderButton.removeEvents().addEvent('click',function(){location.href='/account/emailpreferences';return false;});});}}.bind(this)}).post();});$$('#hotel-info a.url').addEvent('click',function(event,el){omniture.trackFeature('Property click-out: '+property.propertyName);_gaq.push(['_trackEvent','PDP','Property','ClickOut']);});}else{var voucherEl=$('voucher-selector');var ptpEl=$('ptp');if(voucherEl){var vouchers=new VoucherSelector(voucherEl,property.propertyId,Jetsetter.eventId);}else if(ptpEl){var startJourneyEl=ptpEl.getElement('#start-your-journey');if(startJourneyEl){startJourneyEl.addEvent('click',function(event){event.stop();new Ptp(ptpEl,{'propertyId':property.propertyId}).show();});}
var videoConultEl=ptpEl.getElement('#start-your-journey-video');if(videoConultEl){videoConultEl.addEvent('click',function(e){e.stop();new VideoConsultModal().show();});}}else{if($('trip-builder-2')){newCalendarInit(property);}else if($('product-booking')){oldCalendarInit(property);if(!Jetsetter.user.isAnonymous||!Jetsetter.user.isPriceHidden){var rightRailEl=$('com-right-wrapper');var rightRailTopEl=$('com-right');var pageContentWidth=$('page-content').getSize().x;window.addEvent('scroll',function(){var windowScrolled=window.getScroll();var windowSize=window.getSize();var rightRailSize=rightRailEl.getSize();var mainRailSize=mainRailEl.getSize();var canStartFixing=(windowScrolled.y>=rightRailTopEl.getPosition().y);var isWithinContraints=(windowSize.y>rightRailSize.y+20&&windowSize.x>=pageContentWidth);if(canStartFixing&&isWithinContraints){var leftRailElBottom=mainRailEl.getPosition().y+mainRailSize.y;var rightRailElBottom=windowScrolled.y+rightRailSize.y;if(rightRailElBottom>=leftRailElBottom&&!Browser.ie6){var newRightRailY=mainRailSize.y-rightRailSize.y;rightRailEl.removeClass('fixed');rightRailEl.setStyle('margin-top',newRightRailY);}else{rightRailEl.addClass('fixed');rightRailEl.setStyle('margin-top',0);}}else{rightRailEl.removeClass('fixed');}});}}}}
$(document).addEvent('click:relay(.share-modal)',function(){var shareModalOptions={propertyId:property.propertyId,propertyImage:property.propertyImage,propertyName:property.propertyName,propertyLocation:property.propertyLocation};if(property.mode!='archive'){shareModalOptions=Object.merge({bannerTitle:'Share this sale via email',message:Locale.get('Copy.pdp-email-share-message'),saleId:Jetsetter.eventId,expirationTime:property.expirationTime},shareModalOptions);}else{shareModalOptions=Object.merge({bannerTitle:'Share via email',message:'Check out this amazing vacation idea I found on Jetsetter!'},shareModalOptions);}
var shareModal=new ShareModal(shareModalOptions).show();});if(tabContainerEl){tabContainerEl.addEvent('click:relay(a)',function(event,el){event.stop();switchTab(el);});}
mainRailEl.addEvent('click:relay(a)',function(event,element){var href=element.get('href');var uri=new URI(href);var hash=uri.get('fragment');if(href&&hash&&uri.get('host').test(/jetset(ter|www)/)&&!element.hasClass('redirect')){event.preventDefault();var selectedTab=tabContainerEl.getElement('a[href=#'+hash+']');var scrollToEl=(selectedTab)?tabContainerEl:$(hash);if(element.hasClass('no-scroll')){if(selectedTab){switchTab(selectedTab);}}else{var scrollFx=new Fx.Scroll(window);scrollFx.start(0,scrollToEl.getPosition().y-20).chain(function(){if(selectedTab){switchTab(selectedTab);}});}}});var fbWidgetEl=$('fb-widget');if(fbWidgetEl){window.addEvent('fbReady',function(){new FbWidgetLoader(fbWidgetEl,{widget:'share',widgetOptions:{'wallPostContent':{inviteUrl:getPropertyInviteUrl()},'invitationAsyncParams':{'property-id':property.propertyId,'event-id':Jetsetter.eventId},'property':property}});});}
var miniMapEl=$('mini-map');if(miniMapEl){miniMapEl.addEvent('click:relay(.see-full)',function(event,element){event.preventDefault();switchTab($('area-tab'));var scrollToEl=$(new URI(element.get('href')).get('fragment'));var scrollFx=new Fx.Scroll(window);scrollFx.start(0,scrollToEl.getPosition().y);});}
var headerEl=$('header');var mapEl=$('overview').getElement('.google-map');if(mapEl){var loadMap=function(){new GoogleMaps(mapEl,Jetsetter.property.map);window.removeEvent('scroll:pause',loadMapOnScroll);};var loadMapOnScroll=function(){if(window.getScroll().y+window.getSize().y>mapEl.getPosition(headerEl).y){loadMap();}};window.addEvent('scroll:pause',loadMapOnScroll);}
var reviewsEl=$('reviews');if(reviewsEl){var reviewsOptions={eventId:Jetsetter.eventId,propertyId:property.propertyId};if(property.mode!='flash'){reviewsOptions=Object.merge({ignoreEventSpecific:true},reviewsOptions);}
var reviews=new Reviews(reviewsEl,reviewsOptions);;}
var shareEl=$('share');if(shareEl){var fbConnectLink=$('fbConnectLink');fbConnectLink.addEvent('click',function(event){event.stop();omniture.trackFeature('FacebookConnect');_gaq.push(['_trackEvent','PDP','FBConnect','Click']);var inviteUrl=getPropertyInviteUrl();FB.ui({'method':'feed','name':property.propertyName,'description':property.description,'link':inviteUrl,'actions':[{'name':'See more','link':inviteUrl}],'picture':'http:'+Jetsetter.CDN_HOST+'/static/'+property.propertyImage},function(response){});});var getSocialLinks=function(){if(window.getScroll().y+window.getSize().y>shareEl.getPosition(headerEl).y){window.removeEvent('scroll',getSocialLinks);new ProductService().getTwitterUrl({'propertyName':property.propertyName,'propertyAlias':getPropertyKey(),'mode':property.mode,onSuccess:function(data){var twitterLink=$('twitterLink');twitterLink.set('href',data).addEvent('click',function(){omniture.trackFeature('Twitter');_gaq.push(['_trackEvent','PDP','TwitterConnect','Click']);});},onFailure:function(){}})}}
window.addEvent('scroll',getSocialLinks);}
if(commentsEl){var comments=new Comments(commentsEl,{eventId:Jetsetter.eventId,propertyId:property.propertyId});}
var favsTTEl=$('favs-tooltip');if(favsTTEl){favsTooltip=new FavsTooltip(favsTTEl);}
$('page-content').getElements('.add-to-favs').each(function(el,i){new AddFavorite(el);});var publicSidebar=$('public-sidebar');if(publicSidebar){new AuthModal({setScreen:'PublicReg',dismissable:true,dismissOnLogin:true,onLogin:function(){window.location.reload();}}).show();var signupEl=publicSidebar.getElement('.signup'),nextEl=publicSidebar.getElement('#signup-open'),formWrap=publicSidebar.getElement('.form'),signupFx=new Fx.Tween(signupEl,{}),submitFx=new Fx.Tween(nextEl,{}),catchPoint=publicSidebar.getPosition().y-10,stopPoint=$('footer').getPosition().y,formEl=publicSidebar.getElement('form'),topWrap=publicSidebar.getElement('.top-wrap');if(!Browser.ie6){window.addEvent('scroll',function(){var curPos=window.getScroll().y;if(curPos>catchPoint&&curPos<stopPoint){publicSidebar.removeClass('bottom-docked');publicSidebar.addClass('docked');}
else if(curPos>stopPoint){publicSidebar.addClass('bottom-docked');}
else{publicSidebar.removeClass('bottom-docked');publicSidebar.removeClass('docked');}});}
var submitEl=formWrap.getElement('#complete-signup'),emailField=new InviteEmailField(formWrap.getElement('#email'),{'tooltipType':'left','existingMemberCheck':false});formEl.addEvent('submit',function(e){e.stop();emailField.validateField();if(emailField.get('state')!=='valid'){emailField.updateDisplayState();return false;}
else{if(Jetsetter.regOptions){Jetsetter.regOptions.email=emailField.get('value');}else{Jetsetter.regOptions={email:emailField.get('value')}}
var regOptions=Object.merge({'promoAlias':((Jetsetter.session&&Jetsetter.session.pl)?Jetsetter.session.pl.promo:'')},Jetsetter.regOptions);Jetsetter.Auth.authenticate(Object.merge(regOptions,{type:'email',onSuccess:function(json){window.location.reload();}.bind(this),onFailure:function(json){var errorCode=json.error.code,errorMessage=json.error.message;switch(errorCode){default:emailFieldEl.isValid=false;emailFieldEl.updateState(errorMessage);break;}
this.submitButtonEl.set('disabled',false);}.bind(this)}));}});}
$$('.fader .cta-button').each(function(button){button.addEvent('click',function(e){var secureOptions={'access':'insecure',defaultToSubscriberRegistration:true,onCloseEnd:function(){},onLogin:function(){window.location.reload();}};if(Jetsetter.regOptions){secureOptions.promoId=Jetsetter.regOptions.promoId?Jetsetter.regOptions.promoId:'';secureOptions.referrerGuid=Jetsetter.regOptions.referrerGuid?Jetsetter.regOptions.referrerGuid:'';secureOptions.invitationId=Jetsetter.regOptions.invitationId?Jetsetter.regOptions.invitationId:'';secureOptions.promo=Jetsetter.regOptions.promo?Jetsetter.regOptions.promo:'';secureOptions.promoKey=Jetsetter.regOptions.promoKey?Jetsetter.regOptions.promoKey:'';}
Jetsetter.secureLogin(secureOptions);});});var splashInviteEl=$('splash-invite');if(splashInviteEl){var splashInvite=new SplashInvite(splashInviteEl);}
if($('badges')){var badgeEl=$('badges').getElement('.instant-booking');if(badgeEl&&badgeEl.getElement('.info')){new HoverTooltip(badgeEl,{tooltipContent:badgeEl.getElement('.info').get('text'),tooltipHover:true,orientation:'bottom',displayBeforeOpen:0,attachTo:document.body});}}
var virginLink=$('virgin-flight-routes');if(virginLink){virginLink.addEvent('click',function(e){e.stop();new VirginModal(virginLink).show();});}
var pinterestBannerEl=$('pinterest-banner');if(pinterestBannerEl){var j_pinb=Cookie.read('j_pinb');if(!j_pinb){pinterestBannerEl.show();pinterestBannerEl.hide();var pinSlide=new Fx.Slide(pinterestBannerEl.show(),{duration:250}).hide().slideIn();Cookie.write('j_pinb','1',{duration:2});}}
if(Jetsetter.popups.SniqueWelcomeModal){setTimeout(function(){new SniqueWelcomeModal().show();},1000);}
if(Jetsetter.popups.TALandingModal){setTimeout(function(){new TALandingModal().show();},1000);}
showBreadcrumbs();var currUri=new URI(window.location);var refUri=new URI(document.referrer);Jetsetter.tracker.addToQueue({eventType:'saleView',key1:Jetsetter.user.guid,key2:Jetsetter.user.partition,key7:property.propertyId,key8:Jetsetter.eventId,key9:currUri.getData('nm'),key10:currUri.getData('cl'),key15:Jetsetter.session.al&&Jetsetter.session.al.promo_id,key18:currUri.getData('ep'),key19:currUri.getData('et'),key20:currUri.getData('ept'),key21:currUri.getData('eca')});};})(Jetsetter.property);window.addEvent('domready',Jetsetter.packages.product.init);var SniqueWelcomeSlides=new Class({Extends:SlideShow,currentIndex:1,initialize:function(attachTo,creditAmount){var slide2Image=Jetsetter.CDN_HOST+'/static/images/snique-welcome/slide2.png';var slide3Image=Jetsetter.CDN_HOST+'/static/images/snique-welcome/slide3.png';new Image().src=slide2Image;new Image().src=slide3Image;var slidesHtml=['<div class="slide slide-1 first">\
    <p>\
        Jetsetter (formerly SniqueAway) is a community of travelers that provides<br/>\
        our members with exclusive deals of up to <b>40% off</b> the world\'s greatest vacations,<br/>\
        expert knowledge and inspiring articles. We\'re glad you\'re here.\
    </p>\
    <div class="credit-explanation">\
      As a former <b>SniqueAway</b> member,<br/>\
      you\'ve received a credit to your account for:<br/>\
      <h3 class="snique-credit">$'+creditAmount+'</h3>\
    </div>\
   </div>','<div class="slide slide-2 first">\
    <img class="slide-image" src="'+slide2Image+'" />\
   </div>','<div class="slide slide-3 first">\
    <img class="slide-image" src="'+slide3Image+'" />\
   </div>'];var slidesEl=new Element('div',{'class':'slides','html':slidesHtml.join('')});var nextContainerEl=new Element('div',{'class':'next','html':'<span class="copy">Up next:</span> '});this.headerEl=new Element('div',{'class':'slide-header','html':'<h2 class="tenor"></h2>'});this.footerEl=new Element('div',{'class':'slide-footer','html':'<div class="next-button"></div><br clear="right" />\
          <div class="no-thanks">No thanks</div>'});this.slideData=[{title:'Welcome to Jetsetter',buttonText:'How Jetsetter works'},{title:'What to know',buttonText:'How to book'},{title:'What to love',buttonText:'Go travel'}];this.titleEl=this.headerEl.getElement('h2');this.nextButtonEl=this.footerEl.getElement('.next-button').addEvents({'click':function(){if(this.transitioning){return false;}
if(this.currentIndex==this.slideData.length-1){return this.fireEvent('slidesEnd');}
var slideInfo=this.slideData[this.currentIndex+1];this._setTitle(slideInfo.title);this._setButtonText(slideInfo.buttonText);this.show('next');}.bind(this)});this._setTitle(this.slideData[0].title);this._setButtonText(this.slideData[0].buttonText);this.footerEl.getElement('.no-thanks').addEvent('click',function(){this.fireEvent('close')}.bind(this));this.rootEl=new Element('div',{'id':'snique-slides','class':'screen'}).adopt(this.headerEl,slidesEl,this.footerEl).inject(attachTo);this.parent(slidesEl,{transition:'slideInLeft',duration:900});this._setCurrentIndex();},show:function(slide,options){this.parent(slide,options);this._setCurrentIndex();return this;},_setCurrentIndex:function(){this.currentIndex=(this.slides.indexOf(this.current))%this.slides.length;return this;},_setButtonText:function(text){this.nextButtonEl.set('text',text);return this;},_setTitle:function(text){this.titleEl.set('text',text);return this;},toElement:function(){return this.rootEl;}});var SniqueWelcomeModal=new Class({Extends:Modal,creditAmounts:{SAMember:50,SABuyer:100,SATopTier:150,JSSAMember:50,JSSABuyer:100,JSSATopTier:150},initialize:function(options){this.parent({id:'snique-welcome-modal'});var guid=Jetsetter.user&&Jetsetter.user.guid;var url=new URI();var creditAmount=this.creditAmounts[url.get('data')['sniqueMarketingSource']||'SAMember'];var slides=new SniqueWelcomeSlides(this.canvas,creditAmount);slides.addEvents({slidesEnd:function(){_gaq.push(['_trackEvent','snique-onboarding','modal','tourfinished']);this.close();}.bind(this),close:function(){trackClose();this.close();}.bind(this)});this.addEvents({close:function(){trackClose();}.bind(this)});function trackClose(){var eventName=['modal','modal-whattoknow','modal-whattolove'][slides.currentIndex]||'modal';_gaq.push(['_trackEvent','snique-onboarding',eventName,'Closed']);}
Cookie.write('js_snique_welcome','true',{domain:Jetsetter.cookieDomain,path:'/',duration:3650});_gaq.push(['_trackEvent','snique-onboarding','modal-displayed',creditAmount]);}});SniqueWelcomeModal.shouldShow=function(){var url=new URI();var hasSniqueGuid=url.get('data')['DG']&&url.get('data')['sniqueMarketingSource'];var hasExpired=new Date()>new Date('2013-10-01');var userHasSeenModal=!!Cookie.read('js_snique_welcome');return hasSniqueGuid&&!userHasSeenModal&&!hasExpired;};SniqueWelcomeModal.whitelist=['splash','product-details','multisale'];SniqueWelcomeModal.allowPublic=true;var TALandingModal=new Class({Extends:Modal,initialize:function(options){this.parent({id:'ta-landing-modal'});var slides=new TALandingSlides(this.canvas);slides.addEvents({close:function(){this.close();}.bind(this)});this.addEvents({close:function(){trackClose();}.bind(this)});function trackClose(){_gaq.push(['_trackEvent','ta-landing-modal','modal','Closed']);omniture.trackFeature("TA_Landing_Modal Closed");}
_gaq.push(['_trackEvent','ta-landing-modal','modal','Opened']);omniture.trackFeature("TA_Landing_Modal Opened");Cookie.write('js_ta_landing_modal','true',{domain:Jetsetter.cookieDomain,path:'/',duration:3650});}});TALandingModal.shouldShow=function(){var url=new URI();var via=url.get('data')['via'];var hasPromoCode=via&&/^TADeals_.+/.test(via);var userHasSeenModal=!!Cookie.read('js_ta_landing_modal');var userNotLoggedIn=!Jetsetter.user||Jetsetter.user.isPublic;return userNotLoggedIn&&hasPromoCode&&!userHasSeenModal;};TALandingModal.whitelist=['splash','product-details','multisale'];TALandingModal.allowPublic=true;var TALandingSlides=new Class({Extends:SlideShow,currentIndex:1,initialize:function(attachTo){var html='<div class="slide slide-1 first">\
    <p>\
        Jetsetter members receive up to 40% off the <br />world\'s greatest travel experiences.<br/>\
    </p>\
    <div class="cta">\
                    <button class="cta-button submit" type="submit" name="submit">Go Travel</button>\
                </div>\
   </div>';var slidesEl=new Element('div',{'class':'slides','html':html});this.headerEl=new Element('div',{'class':'slide-header','html':'<h2 class="tenor">Welcome to Jetsetter</h2>'});this.footerEl=new Element("div",{'class':'slide-footer','html':'<div class="jetsetter-logo"></div>\
                <div class="trip tenor">A TripAdvisor company</div>'});this.rootEl=new Element('div',{'id':'ta-landing-modal-slides','class':'screen'}).adopt(this.headerEl,slidesEl,this.footerEl).inject(attachTo);this.parent(slidesEl,{transition:'slideInLeft',duration:900});this.rootEl.getElement('.cta-button').addEvent('click',function(){this.fireEvent('close');}.bind(this));},toElement:function(){return this.rootEl;}});